<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Creating Your Own Istio (Part 2.5) - Terminal</title>
  


  <meta name="twitter:site" content="@cvaldezr">
  <meta name="twitter:creator" content="@cvaldezr">
  <meta name="twitter:description" content="Reusable Telemetry" />
  <meta name="twitter:title" content="Creating Your Own Istio (Part 2.5)" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/static/logo/profiler.png" />

  <meta property="og:title" content="Creating Your Own Istio (Part 2.5)" />
  <meta property="og:description" content="Reusable Telemetry" />
  <meta property="og:image" content="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/static/logo/profiler.png" />

  <meta name="description" content="In the last post we create our first container decorator, a container that when included into an arbitrary pod enhance the main container. In our particular case we created a container that override the HTTP 404 responses as an introduction, in this post we are going to build upon and develop some functionalities to monitor the performance of a running service.">
  <meta name="author" content="Cesar">
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/atom-one-dark.min.css" integrity="sha256-akwTLZec/XAFvgYgVH1T5/369lhA2Efr22xzCNl1nHs=" crossorigin="anonymous" />
  <link href="https://cesarvr.iocss/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

  
  <link rel="apple-touch-icon" href="https://cesarvr.ioimg/apple-touch-icon.png">
  <link rel="icon" href="https://cesarvr.ioimg/favicon.ico">
  
  <meta name="generator" content="Hugo 0.62.2" />
  
  <link rel="alternate" type="application/atom+xml" href="https://cesarvr.ioindex.xml" title="Terminal">
  
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://cesarvr.io">Terminal</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/about">About</a>
        </li>
        
        <li class="">
          <a href="/showcase">Showcase</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

  <script
    			  src="https://code.jquery.com/jquery-3.3.1.min.js"
    			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    			  crossorigin="anonymous"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" async></script>
  <script src="https://cesarvr.iojs/db.js"></script>

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title">Creating Your Own Istio (Part 2.5)</h1>
    <p class="post-meta">Cesar Â· 2018.12.1</p>
  </header>
  <div class="post-content"><p>In the last post we create our first <a href="https://cesarvr.io/post/istio-2/">container decorator</a>, a container that when included into an arbitrary pod enhance the main container. In our particular case we created a container that override the HTTP 404 responses as an introduction, in this post we are going to build upon and develop some functionalities to monitor the performance of a running service.</p>
<h3 id="revisiting-the-code">Revisiting The Code</h3>
<p>This is the code from the last post:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">Ambassador</span> }  <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;../node-ambassador/&#39;</span>)

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TARGET</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>[<span style="color:#e6db74">&#39;target_port&#39;</span>] <span style="color:#f92672">||</span> <span style="color:#ae81ff">8087</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PORT</span>   <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>[<span style="color:#e6db74">&#39;port&#39;</span>] <span style="color:#f92672">||</span> <span style="color:#ae81ff">8080</span>

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">HTTP404</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">...</span><span style="color:#e6db74">`</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">override_404</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
  <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:404&#39;</span>, () =&gt; <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">respond</span>(<span style="color:#a6e22e">HTTP404</span>))
}

<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Ambassador</span>({<span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">PORT</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">TARGET</span>})
      .<span style="color:#a6e22e">tunnel</span>({<span style="color:#a6e22e">override_404</span>})

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">listening for request in </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PORT</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> and targeting </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">TARGET</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)
</code></pre></div><p><a href="https://gist.github.com/cesarvr/d9fe6b6fdf8b8f3bba196654141507ef">This code</a> just connects to any server running in <code>TARGET_PORT</code> and override their HTTP 404 responses with the content from the <code>HTTP404</code> string. We are going to use this as our starting point.</p>
<h3 id="network-profiler">Network Profiler</h3>
<hr>
<h4 id="configuration">Configuration</h4>
<p>We can start by writing a new function to subscribe to the <code>Ambassador::tunnel</code> method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">telemetry</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {}

<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Ambassador</span>({<span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">PORT</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">TARGET</span>})
      .<span style="color:#a6e22e">tunnel</span>({<span style="color:#a6e22e">override_404</span>, <span style="color:#a6e22e">telemetry</span>})
</code></pre></div><p>The function <code>telemetry</code> will get called each time a new HTTP request is made by a HTTP client.</p>
<h4 id="request">Request</h4>
<p>The first functionality we want to write is the ability to register the HTTP request details, this will tell us what resources people or other services are looking in our web service.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">telemetry</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
    <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>,  (<span style="color:#a6e22e">header</span>) =&gt; {} )
}
</code></pre></div><p>We setup a listener for the event <code>http:data</code> in the <em>server</em> object and we receive a <code>header</code> object with two fields:</p>
<ul>
<li>
<p><strong>method</strong> The HTTP Method <code>GET, POST, DELETE, PUT,...</code>.</p>
</li>
<li>
<p><strong>endpoint</strong> The resource URL <code>/Resource/1</code>.</p>
</li>
</ul>
<p>Now we save the state into a class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span> {
  <span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">method</span>   <span style="color:#f92672">=</span> <span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">HTTPMethod</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endpoint</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">HTTPResource</span>

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
  }
}
</code></pre></div><p>We create a new class <em>Stats</em> and create the <code>readRequest</code> method taking saving the fields and returning <code>this</code> object. By returning <code>this</code> just make it easy for us to chain calls in the form of <code>stats.a().b()</code>.</p>
<p>We instantiate the <em>Stats</em> class and bind the <code>readRequest</code> method to the event <code>http:data</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span> {
  <span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>) {  <span style="color:#75715e">/*...*/</span>  }
}

<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Stats</span>()

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">telemetry</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
    <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>,  (<span style="color:#a6e22e">header</span>) =&gt; <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>) )
}
</code></pre></div><h4 id="tracking-responses">Tracking Responses</h4>
<p>To capture responses, we need to listen for the <code>http:data</code> event but this time from the <em>service</em> object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>, (<span style="color:#a6e22e">header</span>) =&gt; {})
</code></pre></div><p>We listen the <code>service</code> object for responses which generates a HTTP response object with the following shape:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">  {<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;404&#34;</span>,<span style="color:#e6db74">&#34;message&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;File not found&#34;</span>}
</code></pre></div><p>What we do now is save this data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {
  <span style="color:#a6e22e">readResponse</span>(<span style="color:#a6e22e">response</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">response</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
  }
}  
</code></pre></div><p>We just need to <em>again</em> plug this method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span> {
  <span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>)    { <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">readResponse</span>(<span style="color:#a6e22e">response</span>) { <span style="color:#75715e">/*...*/</span> }
}

<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Stats</span>()

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">telemetry</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
  <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>,  (<span style="color:#a6e22e">header</span>) =&gt; <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>) )
  <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>, (<span style="color:#a6e22e">header</span>) =&gt; <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">readResponse</span>(<span style="color:#a6e22e">header</span>) )
}
</code></pre></div><p>We have information about the request and responses. Next step is to calculate the time it takes for the target container to resolve a request.</p>
<h4 id="latency">Latency</h4>
<p>We are going to write two methods to calculate how much it takes for our a service to respond, one method will time the beginning of the service request (<code>startProfile</code>) and a second method will time the response (<code>endProfile</code>).</p>
<p>Then we are going to calculate difference and we got our total time:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">  latency = end_time - start_time
</code></pre></div><p>Let's implement this idea.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {

  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">startProfile</span>(){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>()
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
  }

  <span style="color:#a6e22e">endProfile</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">end</span> <span style="color:#f92672">=</span>  <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>() <span style="color:#f92672">-</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">start</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
  }
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>We plug this two methods one at the start of the request <code>server-&gt;startProfile</code> the other when the response is being delivered <code>service-&gt;endProfile</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span> {
  <span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>) {    <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">readResponse</span>(<span style="color:#a6e22e">response</span>) { <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">startProfile</span>(){ <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">endProfile</span>()  { <span style="color:#75715e">/*...*/</span> }
}

<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Stats</span>()

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">telemetry</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
  <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>,  (<span style="color:#a6e22e">header</span>) =&gt; <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>)
                                           .<span style="color:#a6e22e">startProfile</span>())
  <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>, (<span style="color:#a6e22e">header</span>) =&gt; <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">readResponse</span>(<span style="color:#a6e22e">header</span>)
                                           .<span style="color:#a6e22e">endProfile</span>())
}
</code></pre></div><p>We used the method chaining discussed before, this way we just subscribe once.</p>
<h3 id="saving-state">Saving State</h3>
<p>To make our <em>Stat</em> class useful we are going to persist its state by creating a nice <em>in-memory</em> database.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span> {
  <span style="color:#a6e22e">constructor</span>(){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> {}
  }
}
</code></pre></div><p>To save the object state in memory we are going to write the method <code>save</code> and to retrieve the data the method <code>all</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {

  <span style="color:#a6e22e">constructor</span>(){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> {}
  }

  <span style="color:#66d9ef">new</span>(){
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">URL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endpoint</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">||</span> {}

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">=</span> { <span style="color:#75715e">/* state */</span> }
  }

  <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">all</span>(){
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>
  }

  <span style="color:#75715e">/*..*/</span>
}
</code></pre></div><p>This would be enough for now for the db, let's focus now on gathering more information.</p>
<h4 id="resource-type">Resource Type</h4>
<p>As you may notice our network profiler doesn't make distinction between a file or a URL. We can solve that by writing a function to detect file extensions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {
<span style="color:#75715e">/*...*/</span>

<span style="color:#a6e22e">isFile</span>(<span style="color:#a6e22e">endpoint</span>) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file_regexp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/\.[0-9a-z]+$/i</span>
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">endpoint</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">file_regexp</span>) <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
}

<span style="color:#75715e">/*...*/</span>
}
</code></pre></div><p>This is good enough for our purposes, let's persist this information.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {
<span style="color:#75715e">/*...*/</span>
  <span style="color:#a6e22e">save</span>(){
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">URL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endpoint</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">||</span> {}

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">=</span> { <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isFile</span>(<span style="color:#a6e22e">URL</span>)  }
  }
<span style="color:#75715e">/*...*/</span>
}
</code></pre></div><h4 id="pod-name">Pod Name</h4>
<p>In case of problems we would like to know where is happening, so it can be interesting to save the pod name.</p>
<blockquote>
<p>If you remember in first post we said that the pod simulates a machine, knowing this we can know the pod name by just looking at the <code>hostname</code> which is simulated by the Linux <a href="https://cesarvr.io/post/2018-05-22-create-containers/">UTS Namespace</a>.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {
  <span style="color:#a6e22e">constructor</span>(){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">os</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;os&#39;</span>)
  }
  <span style="color:#75715e">/*...*/</span>
  <span style="color:#a6e22e">host</span>() {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">hostname</span>()
  }
  <span style="color:#75715e">/*...*/</span>
}
</code></pre></div><p>We use Node.js <a href="https://millermedeiros.github.io/mdoc/examples/node_api/doc/os.html">os::hostname</a> API to get the hostname.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {
<span style="color:#75715e">/*...*/</span>
  <span style="color:#a6e22e">save</span>(){
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">URL</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endpoint</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">||</span> {}

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isFile</span>(<span style="color:#a6e22e">URL</span>),
      <span style="color:#a6e22e">pod</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">host</span>()
    }
  }
<span style="color:#75715e">/*...*/</span>
}
</code></pre></div><h4 id="registry">Registry</h4>
<p>To simplify the diagnose of problems is smart to keep a track record, so we can correlate information and research for obscure runtime errors.</p>
<p>Let's start by writing a new method called history:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">history</span>(<span style="color:#a6e22e">obj</span>) {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">history</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">history</span> <span style="color:#f92672">||</span> []

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">history</span>
}
</code></pre></div><p>This will read an arbitrary object and will check for a field called <code>history</code> if its not there, it create a new field with an <strong>array</strong>.</p>
<h5 id="timing">Timing</h5>
<p>We save here the response latency, request and response. This will give us a picture of the transaction.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">history</span>(<span style="color:#a6e22e">obj</span>) {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">history</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">history</span> <span style="color:#f92672">||</span> []

  <span style="color:#a6e22e">history</span>.<span style="color:#a6e22e">push</span>({
    <span style="color:#a6e22e">request</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">endpoint</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endpoint</span>, <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">method</span>},
    <span style="color:#a6e22e">response</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">response</span>,
    <span style="color:#a6e22e">time</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">end</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;ms&#39;</span>,
    <span style="color:#a6e22e">started</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">start</span>
  })

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">history</span>
}
</code></pre></div><p>This generates the following data structure:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{
	<span style="color:#e6db74">&#34;request&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;endpoint&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/&#34;</span>,
		<span style="color:#e6db74">&#34;method&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;GET&#34;</span>
	},
	<span style="color:#e6db74">&#34;response&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;200&#34;</span>,
		<span style="color:#e6db74">&#34;state&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>
	},
	<span style="color:#e6db74">&#34;time&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;9ms&#34;</span>,
	<span style="color:#e6db74">&#34;started&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1544042305989</span>
}
</code></pre></div><h5 id="container-resource">Container Resource</h5>
<p>Another useful information we can extract from the pod is the memory and CPU usage. You know, Linux can kill our container if we exceed the memory constraints, this feature we can keep track of resources in the container.</p>
<p>We are going to create a new method called <code>resources</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {
  <span style="color:#a6e22e">constructor</span>(){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">os</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;os&#39;</span>)
    <span style="color:#75715e">/*...*/</span>
  }
  <span style="color:#75715e">/*...*/</span>
  <span style="color:#a6e22e">resources</span>(){
    <span style="color:#66d9ef">return</span> {
      <span style="color:#a6e22e">free_memory</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">freemem</span>(),
      <span style="color:#a6e22e">total_memory</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">totalmem</span>(),
      <span style="color:#a6e22e">cpus</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">cpus</span>()
    }
  }
}
</code></pre></div><p>Again here we just use some <a href="https://nodejs.org/api/os.html">os</a> functions to get the job done, I think this can be improve by studying the <code>/proc</code> directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{
	<span style="color:#75715e">/*...*/</span>
	<span style="color:#e6db74">&#34;resource&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;free_memory&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">31891456</span>,
		<span style="color:#e6db74">&#34;total_memory&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">8589934592</span>,
		<span style="color:#e6db74">&#34;cpu&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;cpus&#34;</span><span style="color:#f92672">:</span> [{
				<span style="color:#e6db74">&#34;model&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Intel Xeon...&#34;</span>,
				<span style="color:#e6db74">&#34;speed&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5300</span>,
				<span style="color:#e6db74">&#34;times&#34;</span><span style="color:#f92672">:</span> {
					<span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">153938390</span>,
					<span style="color:#e6db74">&#34;nice&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
					<span style="color:#e6db74">&#34;sys&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">73413290</span>,
					<span style="color:#e6db74">&#34;idle&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">808839530</span>
				}
			},
      <span style="color:#75715e">/* More Cores... */</span>
		}
	}
</code></pre></div><blockquote>
<p>CPU usage time and memory is local to the pod and shared between containers.</p>
</blockquote>
<p>Let add our graph to our main report object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span>  {
  <span style="color:#75715e">/*...*/</span>
  <span style="color:#a6e22e">resources</span>(){ <span style="color:#75715e">/*...*/</span>}

  <span style="color:#a6e22e">history</span>(<span style="color:#a6e22e">obj</span>) {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">history</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">history</span> <span style="color:#f92672">||</span> []

    <span style="color:#a6e22e">history</span>.<span style="color:#a6e22e">push</span>({
      <span style="color:#a6e22e">request</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">endpoint</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endpoint</span>, <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">method</span>},
      <span style="color:#a6e22e">response</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">response</span>,
      <span style="color:#a6e22e">time</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">end</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;ms&#39;</span>,
      <span style="color:#a6e22e">started</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">start</span>,
      <span style="color:#a6e22e">resource</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">resources</span>()
    })

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">history</span>
  }

  <span style="color:#66d9ef">new</span>(){
    <span style="color:#75715e">/*..*/</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>] <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">history</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">history</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>[<span style="color:#a6e22e">URL</span>]),
      <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isFile</span>(<span style="color:#a6e22e">URL</span>),
      <span style="color:#a6e22e">pod</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">host</span>()
    }
  }
  <span style="color:#75715e">/*..*/</span>
}
</code></pre></div><h4 id="reporting">Reporting</h4>
<p>Now it's time to plug our new feature into the <code>tunnel</code> event bus.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stats</span> {
  <span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>) {    <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">readResponse</span>(<span style="color:#a6e22e">response</span>) { <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">startProfile</span>(){ <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">endProfile</span>()  { <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">save</span>()        { <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">isFile</span>(<span style="color:#a6e22e">endpoint</span>) { <span style="color:#75715e">/*...*/</span>}
  <span style="color:#a6e22e">resources</span>()  { <span style="color:#75715e">/*...*/</span> }
  <span style="color:#a6e22e">history</span>(<span style="color:#a6e22e">obj</span>) { <span style="color:#75715e">/*...*/</span> }
}

<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Stats</span>()

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">telemetry</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
  <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>,  (<span style="color:#a6e22e">header</span>) =&gt; <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">header</span>)
                                           .<span style="color:#a6e22e">startProfile</span>())

  <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:data&#39;</span>, (<span style="color:#a6e22e">header</span>) =&gt; <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">readResponse</span>(<span style="color:#a6e22e">header</span>)
                                           .<span style="color:#a6e22e">endProfile</span>()
                                           .<span style="color:#a6e22e">save</span>())
}
</code></pre></div><p>To make this information available, let's create a 5 seconds refresh to show the data collected through standard output. In the next post we are going to replace this for HTTP calls.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Stats</span>()

 <span style="color:#a6e22e">setInterval</span>(()=&gt; {
   <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;logs -&gt; \n &#39;</span>, <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">all</span>))
 }, <span style="color:#ae81ff">5000</span>)

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handleConnection</span>(<span style="color:#a6e22e">server</span>) {
<span style="color:#75715e">/*
</span><span style="color:#75715e">
</span><span style="color:#75715e">*/</span>
}
</code></pre></div><h4 id="deploy">Deploy</h4>
<p>To deploy our changes we can reuse the <a href="https://cesarvr.io/post/istio-2/#build-configuration">build configuration</a> we have created before.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd /project

oc start-build bc/decorator --from-dir<span style="color:#f92672">=</span>. --follow
</code></pre></div><p>And we should see our project running.</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/istio-2.5/profiler.gif" alt=""></p>
<p>This looks nice and all, but is very difficult to make sense of that huge block, for that reason in the next post we are going to write a dashboard so we can make sense of our telemetry at real time.</p>
<p>Here is the code for the <a href="https://github.com/cesarvr/ambassador">decorator container</a>, if you find any optimisation or improvement feel free to send a PR.</p></div>
  <footer class="post-footer">
    
  </footer>
  
  
  
  
</article>
</main>
<footer class="footer">
  <span>&copy; 2020 Cesar</span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantclick/3.0.1/instantclick.min.js" integrity="sha256-SVgP0duWZXZFPVIX+woWPFhpnHcxG5IXS6zvZAVoa3Y=" crossorigin="anonymous"></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  addMenuListener();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    addMenuListener();
  });
  function addMenuListener() {
    var $toggle = document.querySelector('.menu-toggle');
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>

