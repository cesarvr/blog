<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Performance Showdown: Rust vs Javascript :: Cesar&#39;s Bitacora — A simple theme for Hugo</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="After spending some weeks playing with Rust, I felt ready to test my skills and try some programming challenges in the Advent Of Code. My approach to tackle some of those challenges was to solve them on Javascript first (I use it in my day to day) to then port the code to Rust, while porting I just focus on getting the Rust code as elegant as possible. It was after finishing porting this puzzle in particular and feeling a sense of accomplishment that I decided to test how the Rust compiled code will perform against Javascript interpreter."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://cesarvr.io/post/rust-performance/" />





<link rel="stylesheet" href="https://cesarvr.io/assets/style.css">


<link rel="stylesheet" href="https://cesarvr.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://cesarvr.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://cesarvr.io/img/favicon.png">


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://github.com/cesarvr/hugo-blog/blob/master/static/static/logo/ocp.png?raw=true"/>

<meta name="twitter:title" content="Performance Showdown: Rust vs Javascript"/>
<meta name="twitter:description" content="After spending some weeks playing with Rust, I felt ready to test my skills and try some programming challenges in the [Advent Of Code](https://adventofcode.com/). My approach to tackle some of those challenges was to solve them on Javascript first (I use it in my day to day) to then port the code to Rust, while porting I just focus on getting the Rust code as elegant as possible. It was after finishing porting this [puzzle](https://adventofcode.com/2018/day/5) in particular and feeling a sense of accomplishment that I decided to test how the Rust compiled code will perform against Javascript interpreter. "/>



<meta property="og:title" content="Performance Showdown: Rust vs Javascript" />
<meta property="og:description" content="After spending some weeks playing with Rust, I felt ready to test my skills and try some programming challenges in the [Advent Of Code](https://adventofcode.com/). My approach to tackle some of those challenges was to solve them on Javascript first (I use it in my day to day) to then port the code to Rust, while porting I just focus on getting the Rust code as elegant as possible. It was after finishing porting this [puzzle](https://adventofcode.com/2018/day/5) in particular and feeling a sense of accomplishment that I decided to test how the Rust compiled code will perform against Javascript interpreter. " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cesarvr.io/post/rust-performance/" />
<meta property="og:image" content="https://github.com/cesarvr/hugo-blog/blob/master/static/static/logo/ocp.png?raw=true" />
<meta property="article:published_time" content="2020-01-01T19:24:19+01:00" />
<meta property="article:modified_time" content="2020-01-21T14:19:36+00:00" /><meta property="og:site_name" content="Cesar&#39;s Bitacora" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/post">Showcase</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/post">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://cesarvr.io/post/rust-performance/">Performance Showdown: Rust vs Javascript</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2020-01-01
        </span>
      
      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://cesarvr.io/tags/performance/">Performance</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <p>After spending some weeks playing with Rust, I felt ready to test my skills and try some programming challenges in the <a href="https://adventofcode.com/">Advent Of Code</a>. My approach to tackle some of those challenges was to solve them on Javascript first (I use it in my day to day) to then port the code to Rust, while porting I just focus on getting the Rust code as elegant as possible. It was after finishing porting this <a href="https://adventofcode.com/2018/day/5">puzzle</a> in particular and feeling a sense of accomplishment that I decided to test how the Rust compiled code will perform against Javascript interpreter.</p>
<h2 id="naive-algorithm">Naive Algorithm</h2>
<hr>
<p>Before jumping to the whom-was-slower-and-why, let’s take a quick look at <a href="https://adventofcode.com/2018/day/5">puzzle</a> (so you see there is no hidden agenda) which goes like this:</p>
<p>You are given an input string with <code>N</code> amount of characters and we should write an algorithm that find and remove any sequential pairs of characters that similar but have different capitalisation, examples of this are:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">bB <span style="color:#75715e"># Remove</span>
bb <span style="color:#75715e"># Do Nothing</span>
ab <span style="color:#75715e"># Do Nothing</span>
</code></pre></div><p>The algorithm should re-evaluate the string recursively searching for new pairs created after the removal, something like tetris.</p>
<p>We have this input:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># remove bB</span> 
tdabBADp
</code></pre></div><p>We should remove <code>bB</code> to get:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># remove aA</span>
tdaADp

</code></pre></div><p>Then because <code>aA</code> has been formed we should eliminated this too:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># remove dD</span>
tdDp
</code></pre></div><p>Then we remove <code>dD</code> and the final string should be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">tp
</code></pre></div><h3 id="my-solution">My Solution</h3>
<p>To solve this I wrote two functions, one that <code>process</code> an array of strings and fetch a pair each time:</p>
<h4 id="rust">Rust</h4>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">process</span>(tokens: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Vec<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#66d9ef">i32</span> {
  <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> polymer: Vec<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> Vec::new();

  <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Some(token) <span style="color:#f92672">=</span> tokens.pop() {
      <span style="color:#66d9ef">if</span> polymer.is_empty() {
          polymer.push(token);
          <span style="color:#66d9ef">continue</span>;
      }

      <span style="color:#66d9ef">let</span> candidate <span style="color:#f92672">=</span> polymer.pop().unwrap();

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>react(<span style="color:#f92672">&amp;</span>candidate, <span style="color:#f92672">&amp;</span>token) {
          polymer.push(candidate.to_string());
          polymer.push(token.to_string());
      }
  }

  polymer.len() <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i32</span>
}
</code></pre></div><h4 id="javascript">Javascript</h4>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">data</span>) {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">queue</span> <span style="color:#f92672">=</span> []  <span style="color:#75715e">// Save here tested characters.
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">while</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">candidate_1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">pop</span>()
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">candidate_2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">pop</span>() <span style="color:#75715e">// get the last character that passed the test. 
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">candidate_2</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
      <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">candidate_1</span>)
      <span style="color:#66d9ef">continue</span>
    }

    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">react</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">reacting</span>(<span style="color:#a6e22e">candidate_1</span>, <span style="color:#a6e22e">candidate_2</span>)

    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">react</span>) {
      <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">candidate_2</span>)
      <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">candidate_1</span>)
    }
  }

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span>
}

</code></pre></div><blockquote>
<p><em>Notice</em> the <em>performance</em> optimization by keeping the last character in a different queue, that way we don’t need to traverse the whole array looking for matches after a previous removal.</p>
</blockquote>
<p>Then each pair of characters is evaluated using a function called <code>react</code> that returns <code>true</code> or <code>false</code> if the pair need to be removed:</p>
<h4 id="rust-1">Rust</h4>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">
  <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">react</span>(token1: <span style="color:#66d9ef">&amp;</span>String, token2: <span style="color:#66d9ef">&amp;</span>String) -&gt; <span style="color:#66d9ef">bool</span> {
    <span style="color:#66d9ef">if</span> token1.to_lowercase() <span style="color:#f92672">=</span><span style="color:#f92672">=</span> token2.to_lowercase() {
        <span style="color:#66d9ef">return</span> token1 <span style="color:#f92672">!</span><span style="color:#f92672">=</span> token2
    }

    <span style="color:#66d9ef">false</span>
  }
</code></pre></div><h4 id="javascript-1">Javascript</h4>
<hr>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">react</span>(<span style="color:#a6e22e">candidate_1</span>, <span style="color:#a6e22e">candidate_2</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">candidate_1</span>.<span style="color:#a6e22e">toLowerCase</span>() <span style="color:#f92672">===</span> <span style="color:#a6e22e">candidate_2</span>.<span style="color:#a6e22e">toLowerCase</span>()) {
    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">candidate_1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">candidate_2</span> ) {
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
    }
  }

  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
}
</code></pre></div><blockquote>
<p>Basically is a rudimentary implementation of a <strong>equals-ignore-case</strong> plus an additional check to see if they are they same character (the same capitalization).</p>
</blockquote>
<p>To complete the challenge each version (Rust, Javascript) need to reduce a large string (<a href="https://adventofcode.com/2018/day/5/input">50K character</a>) which is good enough to test how well one version performs against the other, then I run each code using Linux <code>time</code> and got this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Javascript (Node.js)</span>
  real  <span style="color:#ae81ff">0</span>m0<span style="color:#f92672">.</span><span style="color:#ae81ff">374</span>s
  user  <span style="color:#ae81ff">0</span>m0<span style="color:#f92672">.</span><span style="color:#ae81ff">301</span>s
  sys   <span style="color:#ae81ff">0</span>m0<span style="color:#f92672">.</span><span style="color:#ae81ff">030</span>s

<span style="color:#75715e"># Rust</span>
  real  <span style="color:#ae81ff">0</span>m0<span style="color:#f92672">.</span><span style="color:#ae81ff">720</span>s
  user  <span style="color:#ae81ff">0</span>m0<span style="color:#f92672">.</span><span style="color:#ae81ff">636</span>s
  sys   <span style="color:#ae81ff">0</span>m0<span style="color:#f92672">.</span><span style="color:#ae81ff">012</span>s
</code></pre></div><p>Now that was unexpected, my first instinctive reaction was to make I was using the correct flag <code>release</code> and <code>opt-level=3</code>, but even if that’s the case this (Rust code) was running natively and this language is supposed to be C++ level of fast. So I started to search for inefficiencies in the code using the ancient <a href="http://www.brendangregg.com/methodology.html">Drunk man anti-method</a> technique which obviously didn’t work, so I settled for the sane approach of running the code through a profiler called <a href="https://perf.wiki.kernel.org/index.php/Main_Page">perf</a>.</p>
<h2 id="debugging">Debugging</h2>
<hr>
<p>Every time you are debugging a performance issues you might feel tempted to start adding your own function to calculate the duration of suspicious section of code (like I used to do, in the past). <a href="http://www.brendangregg.com/perf.html">Perf</a> does this for you by taking various approaches such as listening CPU/Kernel <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/developer_guide/perf">performance events</a> while your process is running. This makes perf the tool of choice to debug performance issues. Let’s see how it works.</p>
<h3 id="debugging-symbols">Debugging Symbols</h3>
<p>Before we start we need to enable the <a href="http://carol-nichols.com/2015/12/09/rust-profiling-on-osx-cpu-time/">debugging symbols</a> on the Rust compiler, this will make <code>perf</code> reports more informative. To enable this just add <code>debug=true</code> to the <code>Cargo.toml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>]
<span style="color:#a6e22e">opt</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">level</span> = <span style="color:#ae81ff">3</span>
<span style="color:#a6e22e">debug</span>=<span style="color:#66d9ef">true</span>
</code></pre></div><h3 id="attaching-perf">Attaching Perf</h3>
<p>I recompiled the code and attached <code>perf</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">cargo build
./target/release/day-5 &amp; perf record -F <span style="color:#ae81ff">99</span> -p <span style="color:#e6db74">`</span>pgrep day-5<span style="color:#e6db74">`</span>
</code></pre></div><ul>
<li>First we run the Rust program (<code>day-5</code>) and we send it to the background using the ampersand (<code>&amp;</code>) symbol.</li>
<li>Next to it, so it executes immediately, we run <code>perf</code> that receives the process identifier (<a href="https://en.wikipedia.org/wiki/Process_identifier">PID</a>) courtesy of <code>pgrep day-5</code>.</li>
<li>The <a href="https://linux.die.net/man/1/pgrep">pgrep</a> command returns the <a href="https://en.wikipedia.org/wiki/Process_identifier">PID</a> of a process by name.</li>
</ul>
<p>Here is the output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">27466</span>
sample size <span style="color:#ae81ff">50003</span>
--
solution 1: <span style="color:#ae81ff">9526</span>
solution 2: <span style="color:#ae81ff">6694</span>


<span style="color:#f92672">[</span> perf record: Woken up <span style="color:#ae81ff">1</span> times to write data <span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>  + <span style="color:#ae81ff">27466</span> <span style="color:#66d9ef">done</span>       ./target/release/day-5
<span style="color:#f92672">[</span> perf record: Captured and wrote 0.002 MB perf.data <span style="color:#f92672">(</span><span style="color:#ae81ff">13</span> samples<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</code></pre></div><h3 id="report">Report</h3>
<p>After running this multiple times,<code>perf</code> automatically aggregates the data to a report file  (<code>perf.data</code>) in the same folder where we are making the call.</p>
<p>Now we can visualise the report with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">perf report
</code></pre></div><p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/rust/perf-1.png" alt=""></p>
<p>Interestingly the algorithm spend <strong>30 percent</strong> of the time in the <a href="https://doc.rust-lang.org/std/string/struct.String.html#method.to_lowercase">String::to_lowercase</a> which is suspicious:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">react</span>(token1: <span style="color:#66d9ef">&amp;</span>String, token2: <span style="color:#66d9ef">&amp;</span>String) -&gt; <span style="color:#66d9ef">bool</span> {
    <span style="color:#66d9ef">if</span> token1.to_lowercase() <span style="color:#f92672">=</span><span style="color:#f92672">=</span> token2.to_lowercase() {  <span style="color:#75715e">// 30% CPU wasted here
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> token1 <span style="color:#f92672">!</span><span style="color:#f92672">=</span> token2
    }

    <span style="color:#66d9ef">false</span>
}
</code></pre></div><p>My first impression is that I made a mistake while running <code>perf</code> (never used it before with Rust), but everything started to make sense once I looked at the source code of the <a href="https://doc.rust-lang.org/std/string/struct.String.html#method.to_lowercase">to_lowercase</a> function.</p>
<p>What happen is that Rust lowercase function try to be correct in any language, so it delegates this conversion to a function called <a href="https://doc.rust-lang.org/1.29.2/std_unicode/conversions/fn.to_lower.html">std_unicode::conversions</a> this function then does a <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary search</a> of each character against a big array (≈1200) of unicode characters:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">
<span style="color:#66d9ef">const</span> to_lowercase_table: <span style="color:#66d9ef">&amp;</span>[(char, [char; <span style="color:#ae81ff">3</span>])] <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>[
        (<span style="color:#e6db74">&#39;\u{41}&#39;</span>, [<span style="color:#e6db74">&#39;\u{61}&#39;</span>, <span style="color:#e6db74">&#39;\0&#39;</span>, <span style="color:#e6db74">&#39;\0&#39;</span>]), 
        (<span style="color:#e6db74">&#39;\u{42}&#39;</span>, [<span style="color:#e6db74">&#39;\u{62}&#39;</span>, <span style="color:#e6db74">&#39;\0&#39;</span>, <span style="color:#e6db74">&#39;\0&#39;</span>]), 
        (<span style="color:#e6db74">&#39;\u{43}&#39;</span>,<span style="color:#75715e">//...≈1200 ]
</span><span style="color:#75715e"></span>

 <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">to_lower</span>(c: <span style="color:#a6e22e">char</span>) -&gt; [char; <span style="color:#ae81ff">3</span>] {
        <span style="color:#66d9ef">match</span> bsearch_case_table(c, to_lowercase_table) {
            None        <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> [c, <span style="color:#e6db74">&#39;\0&#39;</span>, <span style="color:#e6db74">&#39;\0&#39;</span>],
            Some(index) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> to_lowercase_table[index].<span style="color:#ae81ff">1</span>,
        }
    }

</code></pre></div><blockquote>
<p>Going back at the code, this binary search is done twice per iteration now multiply this by <code>50K</code> and we found the reason for the slow down.</p>
</blockquote>
<p>After some googling I found that I should use <a href="https://doc.rust-lang.org/src/core/str/mod.rs.html#4006">eq_ignore_ascii_case</a> instead, which basically makes this operation on <a href="https://doc.rust-lang.org/1.37.0/src/core/slice/mod.rs.html#2487">linear time</a> and for one character is nearly the same as saying constant time. I recompiled the code and run the benchmarks:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">Node.JS
real  0m0.374s
user  0m0.301s
sys   0m0.030s

Rust
real  0m0.283s
user  0m0.248s
sys   0m0.005s
</code></pre></div><p>Now we are talking, profiling have pay its dividends and made the Rust program <code>2.5x</code> <em>faster</em> than the original and <code>91ms</code> faster than the Javascript version, I can start celebrating and telling my friends that I’m a <strong>rustacean</strong> now.</p>
<h2 id="performance-on-macos">Performance On MacOS</h2>
<p>Thing is that I thought this was over, so while I was unpacking my Rust stickers and preparing my laptop for some re-branding, I decided to move the code (Javascript and Rust) from my Linux VM to my main OS (<strong>MacOS Catalina</strong>), once there I gave the benchmark another try because I <em>love</em> suffering:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">Node   0.17s user 0.03s system 101% cpu 0.209 total
Rust   0.23s user 0.01s system 98% cpu 0.238 total
</code></pre></div><p>After seeing this I started to blame MacOS <code>time</code> implementation, but then I calm down and decided to profile the code again this time using <a href="https://developer.apple.com/library/archive/documentation/AnalysisTools/Conceptual/instruments_help-collection/Chapter/Chapter.html">XCode Instrumentation</a> which point me in the right direction:</p>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/rust/malloc-xcode-2.png?raw=true" alt=""></p>
<blockquote>
<p>The slowest part of the program is the part that does the allocation and deallocation of memory produced when calling MacOS <code>malloc</code>.</p>
</blockquote>
<p>To catch this one I'll need to dig more into Rust inner workings. Does this make it more expensive to get performance out of Rust? Did I choose the wrong abstractions? That's for another post. If you want to take a look at the code yourself here is the <a href="https://github.com/cesarvr/AOCRust/tree/master/day-5">Rust</a> and <a href="https://github.com/cesarvr/AOCRust/tree/master/JS">JS</a>, if you have any improvement, idea, suggestions or performance trick let me know by <a href="https://twitter.com/cvaldezr">Twitter</a>, <a href="https://github.com/cesarvr/AOCRust">pull request</a> or <a href="https://github.com/cesarvr/hugo-blog/issues">open an issue</a>.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="https://cesarvr.io/post/self-deploy/">
                  <span class="button__text">Self Deploying Node.JS Applications</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    
    

    
      
        

      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://cesarvr.io/assets/main.js"></script>
<script src="https://cesarvr.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
