<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title> - Terminal</title>
  


  <meta name="twitter:site" content="@cvaldezr">
  <meta name="twitter:creator" content="@cvaldezr">
  <meta name="twitter:description" content="" />
  <meta name="twitter:title" content="" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="" />

  <meta property="og:title" content="" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="" />

  <meta name="description" content="Get your Java source code, tested, packaged, containerized and deployed in four steps. We are going to defined 4 decoupled steps that you can improve with more complex use cases in the future.
Step One Let&#39;s start by defining how the container will be created in Openshift, for this we are going to define a build configuration (AKA BuildConfig).
What is a BuildConfig? A BuildConfig is basically an Openshift object that defines how images are constructed in Openshift, they are four ways to build an image, we are going to use the binary because it give us freedom to choose how to build our software.">
  <meta name="author" content="Cesar">
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/atom-one-dark.min.css" integrity="sha256-akwTLZec/XAFvgYgVH1T5/369lhA2Efr22xzCNl1nHs=" crossorigin="anonymous" />
  <link href="https://cesarvr.iocss/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

  
  <link rel="apple-touch-icon" href="https://cesarvr.ioimg/apple-touch-icon.png">
  <link rel="icon" href="https://cesarvr.ioimg/favicon.ico">
  
  <meta name="generator" content="Hugo 0.62.2" />
  
  <link rel="alternate" type="application/atom+xml" href="https://cesarvr.ioindex.xml" title="Terminal">
  
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://cesarvr.io">Terminal</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/about">About</a>
        </li>
        
        <li class="">
          <a href="/showcase">Showcase</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

  <script
    			  src="https://code.jquery.com/jquery-3.3.1.min.js"
    			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    			  crossorigin="anonymous"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" async></script>
  <script src="https://cesarvr.iojs/db.js"></script>

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title"></h1>
    <p class="post-meta">Cesar Â· 0001.1.1</p>
  </header>
  <div class="post-content"><p>Get your Java source code, tested, packaged, containerized and deployed in four steps. We are going to defined 4 decoupled steps that
you can improve with more complex use cases in the future.</p>
<h2 id="step-one">Step One</h2>
<p>Let's start by defining how the container will be created in Openshift, for this we are going to define a build configuration (AKA <a href="https://cesarvr.io/post/buildconfig/">BuildConfig</a>).</p>
<h3 id="what-is-a-buildconfig">What is a BuildConfig?</h3>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/static/BuildConfig.png?raw=true" alt=""></p>
<p>A BuildConfig is basically an Openshift object that defines how images are constructed in Openshift, they are <a href="https://cesarvr.io/post/buildconfig/">four ways to build an image</a>, we are going to use the <strong>binary</strong> because it give us freedom to choose how to build our software.</p>
<h3 id="defining-our-buildconfig">Defining Our BuildConfig</h3>
<p>To define one we are going to use the command line tool <code>oc-client</code> and it will look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc new-project my-java-services <span style="color:#75715e"># Creates project</span> 
oc new-build redhat-openjdk18-openshift --binary<span style="color:#f92672">=</span>true --name<span style="color:#f92672">=</span>java-microservice 
</code></pre></div><blockquote>
<p>We create a project with a BuildConfig called <code>java-microservice</code> using <code>redhat-openjdk18-openshift</code> as our base and we specify the <strong>binary</strong> flag saying that we want to provide the artifact ourselves.</p>
</blockquote>
<h3 id="deploying-mechanism">Deploying Mechanism</h3>
<p>Next we are going to specify how we deploy images created by <code>java-microservice</code>, for this we are going to use a DeploymentConfig, which basically defines how many replicas and keep sure that our containers are always running.</p>
<p>We need the URL where our image is stored:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc get is 
 <span style="color:#75715e">#   NAME         DOCKER REPO                                                TAGS      UPDATED</span>
 <span style="color:#75715e">#   java-microservice docker-registry.default.svc:5000/my-java-services/java-microservice  ... ...</span>
</code></pre></div><p>We define a deployment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc create deploymentconfig microservice --image<span style="color:#f92672">=</span>docker-registry.default.svc:5000/my-java-services/java-microservice
</code></pre></div><p>We automate the deployment when a new image is created (Optional):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc set triggers dc/microservice --from-image<span style="color:#f92672">=</span>docker-registry.default.svc:5000/my-java-services/java-microservice:latest -c default-container
</code></pre></div><blockquote>
<p>We define that we want to re-deploy our services each time a new image with tag <code>:latest</code> is created.</p>
</blockquote>
<h3 id="traffic">Traffic</h3>
<p>Last step is to configure the traffic allowing our containers to receive traffic:</p>
<pre><code># To expose this container to the cluster.
oc expose dc/microservice --port 8080  

# To expose this service to the internet.
oc expose svc/microservice --port 8080  
</code></pre><p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/static/backbone.PNG" alt=""></p>
<p>Now we got our backbone ready to deploy any image created by our <code>java-microservice</code> <strong>BuildConfig</strong>, now the next step is trigger this by sending a binary tested and packaged by <strong>Jenkins</strong>.</p>
<h2 id="step-two">Step Two</h2>
<p>This part assumes that you already have Jenkins deployed and running in your Openshift cluster, if you haven't do this before, I've wrote <a href="https://github.com/cesarvr/Spring-Boot#configuring-continuous-integration">this small guide</a> to help you get the basics, you can comeback to this point when you finnish the installation.</p>
<p>One advantage of doing our build configuration using the binary strategy is that it give us a &ldquo;common interface&rdquo;, meaning that it doesn't matter if we build our binary with Gradle, Maven or Ant; this build just require that we provide a JAR file.</p>
<p>Spring Boot offers a way to create light weight microservices using an embeded Tomcat, so <a href="https://github.com/cesarvr/GradleOpenShift">let's containerize a Spring Boot </a> microservice using Gradle.</p>
<p>Now let's create a simple Pipeline:</p>
<p><img src="https://github.com/cesarvr/Spring-Boot/blob/master/docs/newPipeline.png?raw=true" alt=""></p>
<p>No we open this pipeline project and go to the scripting part and we define the tools and some variables:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#66d9ef">def</span> project <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my-java-services&#34;</span>   <span style="color:#75715e">// we&#39;ve created this using oc new-project...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> clusterName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;your-openshift-endpoint&#34;</span> <span style="color:#75715e">// Example: https://openshift.console.org. 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> imageBuildConfig <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;java-microservice&#34;</span>  <span style="color:#75715e">// The one we created above.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> GIT_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://github.com/cesarvr/Spring-Boot&#34;</span> <span style="color:#75715e">// Your Spring Boot project. 
</span><span style="color:#75715e"></span>
pipeline <span style="color:#f92672">{</span>
  agent any
 
  tools <span style="color:#f92672">{</span> 
    gradle <span style="color:#e6db74">&#39;Gradle562&#39;</span> <span style="color:#75715e">// You can setup this using Jenkins Global Tools. 
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>We instruct Jenkins to clone, test and package our Java binary:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">   stages <span style="color:#f92672">{</span>
        
    <span style="color:#75715e">/*=============================================*/</span>
    <span style="color:#75715e">/* Clone the project                           */</span>
    <span style="color:#75715e">/*=============================================*/</span>
        
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Preparation&#39;</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
        steps <span style="color:#f92672">{</span>
             git GIT_URL
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">/*=============================================*/</span>
    <span style="color:#75715e">/* We keep Maven related stuff here            */</span>
    <span style="color:#75715e">/*=============================================*/</span>
        
   stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Testing And Packaging&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        steps <span style="color:#f92672">{</span>
            sh   <span style="color:#e6db74">&#39;gradle build&#39;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">/*=============================================*/</span>
</code></pre></div><p>And finally we need to deploy our JAR binary into our BuildConfig:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">   stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Build&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          
        steps <span style="color:#f92672">{</span>
            echo <span style="color:#e6db74">&#34;Pushing The JAR Into OpenShift OpenJDK-Container&#34;</span>
            script <span style="color:#f92672">{</span>
                openshift<span style="color:#f92672">.</span><span style="color:#a6e22e">withCluster</span><span style="color:#f92672">(</span> clusterName <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    openshift<span style="color:#f92672">.</span><span style="color:#a6e22e">withProject</span><span style="color:#f92672">(</span> project <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        openshift
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">selector</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bc&#34;</span><span style="color:#f92672">,</span> imageBuildConfig<span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">startBuild</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;--from-file=build/libs/gs-spring-boot-0.1.0.jar&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;--wait&#34;</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">}</span>
               <span style="color:#f92672">}</span>
              <span style="color:#f92672">}</span>
          <span style="color:#f92672">}</span>
    	  
          post <span style="color:#f92672">{</span>
            success <span style="color:#f92672">{</span>
              archiveArtifacts artifacts: <span style="color:#e6db74">&#39;build/libs/**.jar&#39;</span><span style="color:#f92672">,</span> fingerprint: <span style="color:#66d9ef">true</span>
            <span style="color:#f92672">}</span>
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>Here we are using <a href="https://github.com/openshift/jenkins-client-plugin">Openshift DSL Plugin</a> to select the BuildConfig (<code>java-microservice</code>) and provide the binary and block the task until the container is created.</p>
</blockquote>
</div>
  <footer class="post-footer">
    
  </footer>
  
  
  
  
</article>
</main>
<footer class="footer">
  <span>&copy; 2020 Cesar</span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantclick/3.0.1/instantclick.min.js" integrity="sha256-SVgP0duWZXZFPVIX+woWPFhpnHcxG5IXS6zvZAVoa3Y=" crossorigin="anonymous"></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  addMenuListener();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    addMenuListener();
  });
  function addMenuListener() {
    var $toggle = document.querySelector('.menu-toggle');
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>

