<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title> :: Cesar&#39;s Bitacora — A simple theme for Hugo</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Get your Java source code, tested, packaged, containerized and deployed in four steps. We are going to defined 4 decoupled steps that you can improve with more complex use cases in the future.
Step One Let&#39;s start by defining how the container will be created in Openshift, for this we are going to define a build configuration (AKA BuildConfig).
What is a BuildConfig? A BuildConfig is basically an Openshift object that defines how images are constructed in Openshift, they are four ways to build an image, we are going to use the binary because it give us freedom to choose how to build our software."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://cesarvr.io/post/simple-cdci/" />





<link rel="stylesheet" href="https://cesarvr.io/assets/style.css">


<link rel="stylesheet" href="https://cesarvr.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://cesarvr.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://cesarvr.io/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Get your Java source code, tested, packaged, containerized and deployed in four steps. We are going to defined 4 decoupled steps that you can improve with more complex use cases in the future.
Step One Let&#39;s start by defining how the container will be created in Openshift, for this we are going to define a build configuration (AKA BuildConfig).
What is a BuildConfig? A BuildConfig is basically an Openshift object that defines how images are constructed in Openshift, they are four ways to build an image, we are going to use the binary because it give us freedom to choose how to build our software."/>



<meta property="og:title" content="" />
<meta property="og:description" content="Get your Java source code, tested, packaged, containerized and deployed in four steps. We are going to defined 4 decoupled steps that you can improve with more complex use cases in the future.
Step One Let&#39;s start by defining how the container will be created in Openshift, for this we are going to define a build configuration (AKA BuildConfig).
What is a BuildConfig? A BuildConfig is basically an Openshift object that defines how images are constructed in Openshift, they are four ways to build an image, we are going to use the binary because it give us freedom to choose how to build our software." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cesarvr.io/post/simple-cdci/" />
<meta property="og:site_name" content="Cesar&#39;s Bitacora" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/post">Showcase</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/post">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://cesarvr.io/post/simple-cdci/"></a></h2>
    <div class="post-meta">
      
      
      
    </div>

    

    

    <div class="post-content">
      <p>Get your Java source code, tested, packaged, containerized and deployed in four steps. We are going to defined 4 decoupled steps that
you can improve with more complex use cases in the future.</p>
<h2 id="step-one">Step One</h2>
<p>Let's start by defining how the container will be created in Openshift, for this we are going to define a build configuration (AKA <a href="https://cesarvr.io/post/buildconfig/">BuildConfig</a>).</p>
<h3 id="what-is-a-buildconfig">What is a BuildConfig?</h3>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/static/BuildConfig.png?raw=true" alt=""></p>
<p>A BuildConfig is basically an Openshift object that defines how images are constructed in Openshift, they are <a href="https://cesarvr.io/post/buildconfig/">four ways to build an image</a>, we are going to use the <strong>binary</strong> because it give us freedom to choose how to build our software.</p>
<h3 id="defining-our-buildconfig">Defining Our BuildConfig</h3>
<p>To define one we are going to use the command line tool <code>oc-client</code> and it will look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc new-project my-java-services <span style="color:#75715e"># Creates project</span> 
oc new-build redhat-openjdk18-openshift --binary<span style="color:#f92672">=</span>true --name<span style="color:#f92672">=</span>java-microservice 
</code></pre></div><blockquote>
<p>We create a project with a BuildConfig called <code>java-microservice</code> using <code>redhat-openjdk18-openshift</code> as our base and we specify the <strong>binary</strong> flag saying that we want to provide the artifact ourselves.</p>
</blockquote>
<h3 id="deploying-mechanism">Deploying Mechanism</h3>
<p>Next we are going to specify how we deploy images created by <code>java-microservice</code>, for this we are going to use a DeploymentConfig, which basically defines how many replicas and keep sure that our containers are always running.</p>
<p>We need the URL where our image is stored:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc get is 
 <span style="color:#75715e">#   NAME         DOCKER REPO                                                TAGS      UPDATED</span>
 <span style="color:#75715e">#   java-microservice docker-registry.default.svc:5000/my-java-services/java-microservice  ... ...</span>
</code></pre></div><p>We define a deployment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc create deploymentconfig microservice --image<span style="color:#f92672">=</span>docker-registry.default.svc:5000/my-java-services/java-microservice
</code></pre></div><p>We automate the deployment when a new image is created (Optional):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc set triggers dc/microservice --from-image<span style="color:#f92672">=</span>docker-registry.default.svc:5000/my-java-services/java-microservice:latest -c default-container
</code></pre></div><blockquote>
<p>We define that we want to re-deploy our services each time a new image with tag <code>:latest</code> is created.</p>
</blockquote>
<h3 id="traffic">Traffic</h3>
<p>Last step is to configure the traffic allowing our containers to receive traffic:</p>
<pre><code># To expose this container to the cluster.
oc expose dc/microservice --port 8080  

# To expose this service to the internet.
oc expose svc/microservice --port 8080  
</code></pre><p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/static/backbone.PNG" alt=""></p>
<p>Now we got our backbone ready to deploy any image created by our <code>java-microservice</code> <strong>BuildConfig</strong>, now the next step is trigger this by sending a binary tested and packaged by <strong>Jenkins</strong>.</p>
<h2 id="step-two">Step Two</h2>
<p>This part assumes that you already have Jenkins deployed and running in your Openshift cluster, if you haven't do this before, I've wrote <a href="https://github.com/cesarvr/Spring-Boot#configuring-continuous-integration">this small guide</a> to help you get the basics, you can comeback to this point when you finnish the installation.</p>
<p>One advantage of doing our build configuration using the binary strategy is that it give us a &ldquo;common interface&rdquo;, meaning that it doesn't matter if we build our binary with Gradle, Maven or Ant; this build just require that we provide a JAR file.</p>
<p>Spring Boot offers a way to create light weight microservices using an embeded Tomcat, so <a href="https://github.com/cesarvr/GradleOpenShift">let's containerize a Spring Boot </a> microservice using Gradle.</p>
<p>Now let's create a simple Pipeline:</p>
<p><img src="https://github.com/cesarvr/Spring-Boot/blob/master/docs/newPipeline.png?raw=true" alt=""></p>
<p>No we open this pipeline project and go to the scripting part and we define the tools and some variables:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#66d9ef">def</span> project <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my-java-services&#34;</span>   <span style="color:#75715e">// we&#39;ve created this using oc new-project...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> clusterName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;your-openshift-endpoint&#34;</span> <span style="color:#75715e">// Example: https://openshift.console.org. 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> imageBuildConfig <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;java-microservice&#34;</span>  <span style="color:#75715e">// The one we created above.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> GIT_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://github.com/cesarvr/Spring-Boot&#34;</span> <span style="color:#75715e">// Your Spring Boot project. 
</span><span style="color:#75715e"></span>
pipeline <span style="color:#f92672">{</span>
  agent any
 
  tools <span style="color:#f92672">{</span> 
    gradle <span style="color:#e6db74">&#39;Gradle562&#39;</span> <span style="color:#75715e">// You can setup this using Jenkins Global Tools. 
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>We instruct Jenkins to clone, test and package our Java binary:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">   stages <span style="color:#f92672">{</span>
        
    <span style="color:#75715e">/*=============================================*/</span>
    <span style="color:#75715e">/* Clone the project                           */</span>
    <span style="color:#75715e">/*=============================================*/</span>
        
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Preparation&#39;</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span>
        steps <span style="color:#f92672">{</span>
             git GIT_URL
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">/*=============================================*/</span>
    <span style="color:#75715e">/* We keep Maven related stuff here            */</span>
    <span style="color:#75715e">/*=============================================*/</span>
        
   stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Testing And Packaging&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        steps <span style="color:#f92672">{</span>
            sh   <span style="color:#e6db74">&#39;gradle build&#39;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">/*=============================================*/</span>
</code></pre></div><p>And finally we need to deploy our JAR binary into our BuildConfig:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">   stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Build&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          
        steps <span style="color:#f92672">{</span>
            echo <span style="color:#e6db74">&#34;Pushing The JAR Into OpenShift OpenJDK-Container&#34;</span>
            script <span style="color:#f92672">{</span>
                openshift<span style="color:#f92672">.</span><span style="color:#a6e22e">withCluster</span><span style="color:#f92672">(</span> clusterName <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    openshift<span style="color:#f92672">.</span><span style="color:#a6e22e">withProject</span><span style="color:#f92672">(</span> project <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        openshift
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">selector</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bc&#34;</span><span style="color:#f92672">,</span> imageBuildConfig<span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">startBuild</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;--from-file=build/libs/gs-spring-boot-0.1.0.jar&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;--wait&#34;</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">}</span>
               <span style="color:#f92672">}</span>
              <span style="color:#f92672">}</span>
          <span style="color:#f92672">}</span>
    	  
          post <span style="color:#f92672">{</span>
            success <span style="color:#f92672">{</span>
              archiveArtifacts artifacts: <span style="color:#e6db74">&#39;build/libs/**.jar&#39;</span><span style="color:#f92672">,</span> fingerprint: <span style="color:#66d9ef">true</span>
            <span style="color:#f92672">}</span>
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>Here we are using <a href="https://github.com/openshift/jenkins-client-plugin">Openshift DSL Plugin</a> to select the BuildConfig (<code>java-microservice</code>) and provide the binary and block the task until the container is created.</p>
</blockquote>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://cesarvr.io/post/2015-09-01-archlinux-install/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Arch Linux install cheat sheet</span>
                </a>
              </span>
            
            
          </div>
        </div>
      
    
    

    
      
        

      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://cesarvr.io/assets/main.js"></script>
<script src="https://cesarvr.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
