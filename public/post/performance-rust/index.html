<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Performance Profiling in Rust - Terminal</title>
  


  <meta name="twitter:site" content="@cvaldezr">
  <meta name="twitter:creator" content="@cvaldezr">
  <meta name="twitter:description" content="Writing performant Rust code." />
  <meta name="twitter:title" content="Performance Profiling in Rust" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://github.com/cesarvr/hugo-blog/blob/master/static/static/logo/ocp.png?raw=true" />

  <meta property="og:title" content="Performance Profiling in Rust" />
  <meta property="og:description" content="Writing performant Rust code." />
  <meta property="og:image" content="https://github.com/cesarvr/hugo-blog/blob/master/static/static/logo/ocp.png?raw=true" />

  <meta name="description" content="I had the impression that Rust being a system language its performance should be comparable only to C/C&#43;&#43; and that the worst code in Rust should be faster than good code written in a high level language such as JavaScript. I discover that that&#39;s surprisingly not always the true.
This happened while I was trying to learn Rust programming language by solving the day-5 puzzle on this website called Advent Of Code 2018.">
  <meta name="author" content="Cesar">
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/atom-one-dark.min.css" integrity="sha256-akwTLZec/XAFvgYgVH1T5/369lhA2Efr22xzCNl1nHs=" crossorigin="anonymous" />
  <link href="https://cesarvr.iocss/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

  
  <link rel="apple-touch-icon" href="https://cesarvr.ioimg/apple-touch-icon.png">
  <link rel="icon" href="https://cesarvr.ioimg/favicon.ico">
  
  <meta name="generator" content="Hugo 0.62.2" />
  
  <link rel="alternate" type="application/atom+xml" href="https://cesarvr.ioindex.xml" title="Terminal">
  
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://cesarvr.io">Terminal</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/about">About</a>
        </li>
        
        <li class="">
          <a href="/showcase">Showcase</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

  <script
    			  src="https://code.jquery.com/jquery-3.3.1.min.js"
    			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    			  crossorigin="anonymous"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" async></script>
  <script src="https://cesarvr.iojs/db.js"></script>

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title">Performance Profiling in Rust</h1>
    <p class="post-meta">Cesar Â· 2019.8.7</p>
  </header>
  <div class="post-content"><p>I had the impression that Rust being a system language its performance should be comparable only to C/C++ and that the worst code in Rust should be faster than good code written in a high level language such as JavaScript. I discover that that's surprisingly not always the true.</p>
<p>This happened while I was trying to learn Rust programming language by solving the <a href="https://adventofcode.com/2018/day/5">day-5 puzzle</a> on this website called <a href="https://adventofcode.com/">Advent Of Code 2018</a>. In that puzzle I would have to write an algorithm that find in a strings for a pair of letters that are equals have different capitalisation, once found I should remove it from the string.</p>
<p>For example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">abBAp
</code></pre></div><p>I should remove:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">bB
</code></pre></div><p>Then:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">aA
</code></pre></div><p>With the final result of <code>p</code>.</p>
<p>I wrote two functions, one that <strong>scan</strong> the string looking for pair of characters and the another one that test if a pair of characters follows above rules for deletion.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">fn</span> <span style="color:#a6e22e">react</span>(<span style="color:#a6e22e">token1</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span>String, <span style="color:#a6e22e">token2</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span>String) <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">bool</span> {
    <span style="color:#75715e">// Are they equals ignoring the case.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">token1</span>.<span style="color:#a6e22e">to_lowercase</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">token2</span>.<span style="color:#a6e22e">to_lowercase</span>() {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">token1</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">token2</span>
    }

    <span style="color:#66d9ef">false</span> <span style="color:#75715e">// if they don&#39;t match we just move on.
</span><span style="color:#75715e"></span>}
</code></pre></div><p>Then and just for curiosity I wrote another version of this algorithm on Javascript for <code>NodeJS 10</code> and the for fun just started a benchmark armed with a huge input <a href="https://raw.githubusercontent.com/cesarvr/AOCRust/master/day-5/input.txt">50K characters</a> and Linux <code>time</code> for benchmark.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">Node.JS
  real	0m0.374s
  user	0m0.301s
  sys	0m0.030s

Rust
  real	0m0.720s
  user	0m0.636s
  sys  	0m0.012s
</code></pre></div><p><img src="https://media.giphy.com/media/2wSaulb0fsDydh0IoB/giphy.gif" alt=""></p>
<p>My first reaction was to do what serious <em>Senior Software Engineer</em> would do, I ask Google for Rust compiler optimisation options. The search came up with a <a href="http://carol-nichols.com/2015/12/09/rust-profiling-on-osx-cpu-time/">good article</a> on how to pass flags to the compiler.</p>
<p>I added the optimisation flag to the <code>Cargo.toml</code> and run the benchmark again.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[<span style="color:#a6e22e">package</span>]
<span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;day-5-puzzle&#34;</span>
<span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;0.1.0&#34;</span>
<span style="color:#a6e22e">authors</span> = [<span style="color:#e6db74">&#34;cesar&#34;</span>]
<span style="color:#a6e22e">edition</span> = <span style="color:#e6db74">&#34;2018&#34;</span>

[<span style="color:#a6e22e">dependencies</span>]

[<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>]
<span style="color:#a6e22e">opt</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">level</span> = <span style="color:#ae81ff">3</span>
</code></pre></div><p>After I did this, I recompile and run the benchmarks one more time:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">Node.JS
  real	0m0.374s
  user	0m0.301s
  sys	0m0.030s

Rust  
  real	0m0.723s
  user	0m0.642s
  sys  	0m0.010s
</code></pre></div><blockquote>
<p>Now is even worst&hellip;</p>
</blockquote>
<p>It was clear that some piece of code is or pattern is killing performance, so after a few hours applying the <a href="http://www.brendangregg.com/methodology.html">&ldquo;Drunk Man Anti-Method&rdquo;</a> techniques to my Rust code, I started to consider that maybe the best way to find out the problem was to profile the code using <a href="https://perf.wiki.kernel.org/index.php/Main_Page">Linux perf</a>, the problem was that I wasn't sure that it would work very well with Rust.</p>
<h4 id="install">Install</h4>
<p>For those who never hear before about <a href="https://perf.wiki.kernel.org/index.php/Main_Page">perf</a>, it's a powerful <strong>Linux</strong> tool to profile programs at runtime, to install it you can use your favourite package manager:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#install perf in Archlinux</span>
sudo pacman -Sy perf

<span style="color:#75715e">#install perf in Fedora</span>
sudo dnf install perf

<span style="color:#75715e">#ubuntu</span>
sudo apt install linux-tools-common
</code></pre></div><h4 id="syntax">Syntax</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"> perf record -F <span style="color:#ae81ff">99</span> -p <span style="color:#e6db74">`</span>PID<span style="color:#e6db74">`</span>
</code></pre></div><ul>
<li><code>record</code> it samples a process.</li>
<li><code>F</code> You specify the sampling frequency <code>99hz</code>.</li>
<li><code>p</code> We need here the process identifier (PID).</li>
</ul>
<h4 id="rust-debug-symbols">Rust Debug Symbols</h4>
<p>Enabling debugging symbols will make the <a href="http://carol-nichols.com/2015/12/09/rust-profiling-on-osx-cpu-time/">profiling</a> experience more enjoyable by adding source code to the sampling.</p>
<p>Adding <code>debug</code> property to <code>Cargo.toml</code> will enable it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>]
<span style="color:#a6e22e">opt</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">level</span> = <span style="color:#ae81ff">3</span>
<span style="color:#a6e22e">debug</span>=<span style="color:#66d9ef">true</span>
</code></pre></div><h4 id="profiling">Profiling</h4>
<p>Now we just need to execute the program and attach <code>perf</code> like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./target/release/day-5 &amp; perf record -F <span style="color:#ae81ff">99</span> -p <span style="color:#e6db74">`</span>pgrep day-5<span style="color:#e6db74">`</span>

<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">27466</span>
sample size <span style="color:#ae81ff">50003</span>
--
solution 1: <span style="color:#ae81ff">9526</span>
solution 2: <span style="color:#ae81ff">6694</span>
<span style="color:#f92672">[</span> perf record: Woken up <span style="color:#ae81ff">1</span> times to write data <span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>  + <span style="color:#ae81ff">27466</span> <span style="color:#66d9ef">done</span>       ./target/release/day-5
<span style="color:#f92672">[</span> perf record: Captured and wrote 0.002 MB perf.data <span style="color:#f92672">(</span><span style="color:#ae81ff">13</span> samples<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</code></pre></div><p>After sampling the process multiple times, we can visualise it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">perf report
</code></pre></div><p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/rust/perf-1.png" alt=""></p>
<blockquote>
<p>This simple old-school UI shows where our program is spending the CPU cycles.</p>
</blockquote>
<p>Interestingly the program spend a lot of time in this area:</p>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/rust/perf-hotspot.png?raw=true" alt="Hotspot"></p>
<p>I didn't occur to me that <a href="https://doc.rust-lang.org/std/string/struct.String.html#method.to_lowercase">String::to_lowercase</a> was so expensive and here is why:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">token1</span>.<span style="color:#a6e22e">to_lowercase</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">token2</span>.<span style="color:#a6e22e">to_lowercase</span>()
</code></pre></div><blockquote>
<p>Every time use <a href="https://doc.rust-lang.org/std/string/struct.String.html#method.to_lowercase">to_lowercase</a> the code underneath does a binary search against a <a href="https://doc.rust-lang.org/1.29.2/src/core/unicode/tables.rs.html#1297">UTF-8 lookup table</a> per each character in the string.</p>
</blockquote>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/rust/call-stack.png?raw=true" alt=""></p>
<p>A faster alternative is to use <a href="https://doc.rust-lang.org/src/core/str/mod.rs.html#3961">eq_ignore_ascii_case</a>, this one operate with ASCII characters which make this operation almost constant time.</p>
<p><a href="https://github.com/cesarvr/AOCRust/compare/master...perf">After some replacement</a> I recompiled the program and run the benchmarks again:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">Node.JS
real	0m0.374s
user	0m0.301s
sys	0m0.030s

Rust
real	0m0.283s
user	0m0.248s
sys	0m0.005s
</code></pre></div><p><img src="https://media.giphy.com/media/W9WSk4tEU1aJW/giphy.gif" alt=""></p>
<blockquote>
<p>Now this looks better&hellip;</p>
</blockquote>
<p>This simple change made the program 2.5x faster, now we are talking.</p>
<h3 id="lessons-learned">Lessons Learned</h3>
<p>This experiment make me think about the amount of time that we think on terms about speed like absolute metric, but we should take into consideration how resilient is a programming language running non-expert code.</p>
<p>Well here are some take aways from this experience, if you want to choose a language assuming that is faster, you should take in account the time you are willing to spend optimising your first <strong>naive algorithm</strong> implementation. Of course as soon as you get more experience you will be able to hit the performance sweet spot.</p>
<p>Languages JS or Go seems to have a lower barrier in this regard and is something you should consider when choosing a language for a new project that may require good performance but not exceptional.</p>
<p>In the other hand if you need exceptional performance and you are willing to profile your program with discipline, then Rust the right choice in my opinion, not only give you speed but also provides you with a safety net of having a compiler helping (or annoying) you about common memory mistakes and vulnerabilities. No wonder <a href="https://www.wired.com/2016/03/epic-story-dropboxs-exodus-amazon-cloud-empire/">Dropbox use Rust</a> for their distributed filesystem.</p>
<h3 id="wrapping-up">Wrapping Up</h3>
<p>Me personally I like to learn about low-level stuff in Linux and Rust helps to write programs that are close to the metal while keeping the illusion of high level.</p>
<p>Also I want to write another article because, if you run this algorithm on <strong>MacOSX</strong> I discover that my Rust implementation is again <strong>slower</strong> or on par with the runtimes languages <strong>again</strong>, take a look at this:</p>
<h5 id="macosx">MacOSX</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">Rust      0.21s user 0.01s system 97% cpu 0.220 total
Node.js   0.17s user 0.08s system 61% cpu 0.409 total
Go        0.20s user 0.01s system 111% cpu 0.191 total
</code></pre></div><p>In my next post I'm going to talk about the causes for this <strong>performance degradation</strong>, how to use <a href="https://developer.apple.com/library/archive/documentation/AnalysisTools/Conceptual/instruments_help-collection/Chapter/Chapter.html">Xcode Instruments</a> to profile Rust on MacOSX and explore if we can do something about it.</p>
<p>If you have any improvements on the algorithms above or any suggestion on how to make them faster <a href="https://twitter.com/cvaldezr">let me know</a>.</p>
</div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="https://cesarvr.iotags/programming/">Programming</a></li>
      
      <li><a href="https://cesarvr.iotags/performance/">Performance</a></li>
      
    </ul>
    
  </footer>
  
  
  
  
</article>
</main>
<footer class="footer">
  <span>&copy; 2020 Cesar</span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantclick/3.0.1/instantclick.min.js" integrity="sha256-SVgP0duWZXZFPVIX+woWPFhpnHcxG5IXS6zvZAVoa3Y=" crossorigin="anonymous"></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  addMenuListener();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    addMenuListener();
  });
  function addMenuListener() {
    var $toggle = document.querySelector('.menu-toggle');
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>

