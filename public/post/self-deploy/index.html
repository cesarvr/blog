<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Self Deploying Node.JS Applications :: Cesar&#39;s Bitacora — A simple theme for Hugo</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Few days ago I was watching in Youtube a talk given by Kelsey Hightower titled &amp;ldquo;Self Deploying Kubernetes Applications&amp;rdquo;. In this talk which is a bit old now (over a year) he was demoing a Golang application capable of running locally but also capable of magically deploy itself into a Kubernetes cluster.
"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://cesarvr.io/post/self-deploy/" />





<link rel="stylesheet" href="https://cesarvr.io/assets/style.css">


<link rel="stylesheet" href="https://cesarvr.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://cesarvr.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://cesarvr.io/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Self Deploying Node.JS Applications"/>
<meta name="twitter:description" content="Let&#39;s write an application that runs itself into OpenShift."/>



<meta property="og:title" content="Self Deploying Node.JS Applications" />
<meta property="og:description" content="Let&#39;s write an application that runs itself into OpenShift." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cesarvr.io/post/self-deploy/" />
<meta property="article:published_time" content="2019-02-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-10-23T20:18:52+01:00" /><meta property="og:site_name" content="Cesar&#39;s Bitacora" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/post">Showcase</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/post">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://cesarvr.io/post/self-deploy/">Self Deploying Node.JS Applications</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-02-20
        </span>
      
      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://cesarvr.io/tags/openshift/">openshift</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <p>Few days ago I was watching in <a href="https://www.youtube.com/watch?v=XPC-hFL-4lU">Youtube a talk</a> given by <a href="https://twitter.com/kelseyhightower">Kelsey Hightower</a> titled &ldquo;Self Deploying Kubernetes Applications&rdquo;. In this talk which is a bit old now (over a year) he was demoing a <a href="https://golang.org">Golang</a> application capable of running locally but also capable of <em>magically</em> deploy itself into a Kubernetes cluster.</p>
<p>This is how think deploying applications to the cloud should be, instead of copy/pasting configuration files or issuing cryptic commands we should  aim to make this task simple, after all the tools we use are just a mean to an end. So after watching the talk I started to think on how I can achieve this, how I can make a process deploy itself and how to do it using my favorite programming language Javascript/Node.JS.</p>
<p>After a few days of hacking with Kubernetes/OpenShift REST API, I finally end up writing a small module that when imported ( or required) in a Node.JS application it extends its runtime options allowing it to run in a OpenShift cluster (at the moment) by just adding a simple flag <code>--cloud</code>. From the point of view of a non-expert it will looks like OpenShift is just a JavaScript interpreter.</p>
<h2 id="hello-world">Hello World</h2>
<p>Let's see how this works by writing a simple web server.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;Running...&#39;</span>)
<span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;http&#39;</span>)
    .<span style="color:#a6e22e">createServer</span>((<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
        <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">end</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">&lt;HTML&gt;
</span><span style="color:#e6db74">                    &lt;h1&gt;Hello From -&gt; </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">platform</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/h1&gt;
</span><span style="color:#e6db74">                    &lt;h2&gt;Visitor: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">count</span><span style="color:#f92672">++</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> &lt;/h2&gt;
</span><span style="color:#e6db74">                &lt;/HTML&gt;</span><span style="color:#e6db74">`</span>)
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">response: </span><span style="color:#e6db74">${</span>Date.<span style="color:#a6e22e">now</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)
    }).<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">8080</span>)
</code></pre></div><p>In this 9 lines we defined a HTTP/Server listening in Port 8080, serving a webpage that shows a counter with the visitors and the OS platform so we can see what OS is running our script.</p>
<p>We save this file with the name <code>app.js</code> and run test it locally:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  node app   <span style="color:#75715e"># app.js</span>
</code></pre></div><p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/self-deploy/self-deploy-before.gif?raw=true" alt=""></p>
<!-- raw HTML omitted -->
<h3 id="getting-started">Getting Started</h3>
<p>Before continue you'll need an OpenShift cluster up and running, the easiest way is to subscribe here <a href="https://manage.openshift.com/">OpenShift Online</a> for free or if you <em>feel strong</em> you can setup one in your computer via <a href="https://github.com/minishift/minishift">Minishift</a> or <a href="https://github.com/cesarvr/Openshift#ocup">oc cluster-up</a>.</p>
<p>Once you have OpenShift sorted out, you'll need to create a project/namespace manually, you can do this by login into the web console and clicking into new project.</p>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/self-deploy/making-project.gif?raw=true" alt=""></p>
<!-- raw HTML omitted -->
<p>Now we should get back to our working directory and install <code>okd-runner</code> <a href="https://www.npmjs.com/package/okd-runner">module from npm</a>, this is the module that does the <em>magic</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install install okd-runner --save
</code></pre></div><p>We add the module:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">run</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;okd-runner&#39;</span>) <span style="color:#75715e">// &lt;- self-deploy module
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;http&#39;</span>)
    .<span style="color:#a6e22e">createServer</span>((<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
        <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">end</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">&lt;HTML&gt;
</span><span style="color:#e6db74">                    &lt;h1&gt;Hello From -&gt; </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">platform</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/h1&gt;
</span><span style="color:#e6db74">                    &lt;h2&gt;Visitor: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">count</span><span style="color:#f92672">++</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> &lt;/h2&gt;
</span><span style="color:#e6db74">                &lt;/HTML&gt;</span><span style="color:#e6db74">`</span>)
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">response: </span><span style="color:#e6db74">${</span>Date.<span style="color:#a6e22e">now</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)
    }).<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">8080</span>)
</code></pre></div><p>By adding this module you still can run your application locally, the only difference is that now you can choose a different execution runtime by passing the <code>--cloud</code> flag, this flag will tell your JS program to run in OpenShift:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  node app --cloud   <span style="color:#75715e"># or node app -c for short</span>
</code></pre></div><ul>
<li>The first time it will ask you for your cluster credentials:</li>
</ul>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/self-deploy/credentials.png?raw=true" alt=""></p>
<ul>
<li>And also to choose the namespace/project:</li>
</ul>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/self-deploy/namespace.png?raw=true" alt=""></p>
<h5 id="runtime">Runtime</h5>
<p>After that your application will start the deployment:</p>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/self-deploy/self-deployment.gif?raw=true" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">...
building  ok
URL:  http://my-app-dev-01.7e14.starter-us-west-2.openshiftapps.com
...
...
npm info using node@v10.14.0
npm info lifecycle my-app@1.0.0~prestart: my-app@1.0.0
npm info lifecycle my-app@1.0.0~start: my-app@1.0.0

&gt; my-app@1.0.0 start /opt/app-root/src
&gt; node app.js

response: <span style="color:#ae81ff">1550511176623</span>
...
</code></pre></div><p>Here you can see the logs of you container plus the URL, to exit you just need to press <code>Ctrl-C</code> and you will get back to your console.</p>
<h5 id="updating">Updating</h5>
<p>From now everything is similar as to run your application locally, let's add a line of code to get the pods name, this way showcase how we can make an update:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">run</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;okd-runner&#39;</span>)
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;listening in 8080&#39;</span>)
<span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;http&#39;</span>)
    .<span style="color:#a6e22e">createServer</span>((<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
        <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">end</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">&lt;HTML&gt;
</span><span style="color:#e6db74">                    &lt;h1&gt;Hello From </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">platform</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/h1&gt;
</span><span style="color:#e6db74">                    &lt;h2&gt;Visitors </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">count</span><span style="color:#f92672">++</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> &lt;/h2&gt;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">                    &lt;!-- changes --&gt;
</span><span style="color:#e6db74">                    &lt;p&gt;Pod </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;os&#39;</span>).<span style="color:#a6e22e">hostname</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;p&gt;
</span><span style="color:#e6db74">                    &lt;img src=&#34;https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif&#34;&gt;
</span><span style="color:#e6db74">                    &lt;!--         --&gt;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">                &lt;/HTML&gt;</span><span style="color:#e6db74">`</span>)
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">response: </span><span style="color:#e6db74">${</span>Date.<span style="color:#a6e22e">now</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)
    }).<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">8080</span>)

</code></pre></div><p>We run our application again:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  node app --cloud
</code></pre></div><p>This time it goes straight to deployment.</p>
<p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/self-deploy/oc-update.gif?raw=true" alt=""></p>
<h5 id="cleaning-up">Cleaning up</h5>
<p>To remove your application you just need to pass the <code>-rm</code> flag:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">node</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">rm</span>
</code></pre></div><p>You see not a single YAML file, hope this module helps you simplify your workflow while developing Node.JS micro-services. Also this module is still under development so feel free to <a href="https://github.com/cesarvr/okd-runner">contribute</a> by sending suggestions, pull request, improvements or by opening an <a href="https://github.com/cesarvr/okd-runner/issues">issue</a>.</p>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://cesarvr.io/post/rust-performance/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Performance Showdown: Rust vs Javascript</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://cesarvr.io/post/istio-4/">
                  <span class="button__text">Creating Your Own Istio (Part 3) - Dashboard</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    
    

    
      
        

      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://cesarvr.io/assets/main.js"></script>
<script src="https://cesarvr.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
