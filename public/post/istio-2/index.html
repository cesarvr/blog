<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Creating Your Own Istio (Part 2) - Terminal</title>
  


  <meta name="twitter:site" content="@cvaldezr">
  <meta name="twitter:creator" content="@cvaldezr">
  <meta name="twitter:description" content="Decorating services at runtime." />
  <meta name="twitter:title" content="Creating Your Own Istio (Part 2)" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://github.com/cesarvr/hugo-blog/blob/master/static/static/logo/ocp.png?raw=true" />

  <meta property="og:title" content="Creating Your Own Istio (Part 2)" />
  <meta property="og:description" content="Decorating services at runtime." />
  <meta property="og:image" content="https://github.com/cesarvr/hugo-blog/blob/master/static/static/logo/ocp.png?raw=true" />

  <meta name="description" content="Let&#39;s talk about container oriented programming&hellip;">
  <meta name="author" content="Cesar">
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/atom-one-dark.min.css" integrity="sha256-akwTLZec/XAFvgYgVH1T5/369lhA2Efr22xzCNl1nHs=" crossorigin="anonymous" />
  <link href="https://cesarvr.iocss/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

  
  <link rel="apple-touch-icon" href="https://cesarvr.ioimg/apple-touch-icon.png">
  <link rel="icon" href="https://cesarvr.ioimg/favicon.ico">
  
  <meta name="generator" content="Hugo 0.62.2" />
  
  <link rel="alternate" type="application/atom+xml" href="https://cesarvr.ioindex.xml" title="Terminal">
  
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://cesarvr.io">Terminal</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/about">About</a>
        </li>
        
        <li class="">
          <a href="/showcase">Showcase</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

  <script
    			  src="https://code.jquery.com/jquery-3.3.1.min.js"
    			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    			  crossorigin="anonymous"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" async></script>
  <script src="https://cesarvr.iojs/db.js"></script>

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title">Creating Your Own Istio (Part 2)</h1>
    <p class="post-meta">Cesar Â· 2018.11.7</p>
  </header>
  <div class="post-content"><p>Let's talk about container oriented programming&hellip;</p>
<h3 id="decorator-pattern-101">Decorator Pattern 101</h3>
<p>Take a look at this class:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Server</span> {
  <span style="color:#a6e22e">get404</span> () {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Boring 404 Page&#39;</span>
  }
}
</code></pre></div><p>Let's say we want to change the return message for the method <code>get404</code> but we don't want to touch that code, because maybe we need the original boring message in the future, to solve this we decide to create a decorator class:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServerDecorator</span> {
  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">server</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">server</span>
  }
  <span style="color:#a6e22e">get404</span> () {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">get404</span>().<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;Boring&#39;</span>, <span style="color:#e6db74">&#39;Cool!&#39;</span>)
  }
}
</code></pre></div><p>We can decorate now the <em>Server</em> object at runtime:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>( <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Server</span>().<span style="color:#a6e22e">get404</span>() )
<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>( <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ServerDecorator</span>( <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Server</span>() ).<span style="color:#a6e22e">get404</span>() )

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Boring</span> <span style="color:#ae81ff">404</span> <span style="color:#a6e22e">Page</span>
<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Cool</span><span style="color:#f92672">!</span> <span style="color:#ae81ff">404</span> <span style="color:#a6e22e">Page</span>
</code></pre></div><h4 id="advantages">Advantages</h4>
<p>From the point of view of the <em>Server</em> class the original functionality is untouched, the tests <em>presumably</em> should still pass and the <em>consumers</em> of this class don't require any update. Also <em>decorators</em> logic belongs to its own class making it easy to maintain and it has the added bonus of being able to enhance any object that understand the message <code>get404</code>. This properties give us the confidence we need to deal with a world where business requirements follows the <em>rules</em> of quantum mechanics.</p>
<p>Can we take this flexibility to containers? Of course, we are going to apply those rules and design a container that when deployed into an existing pod <em>decorates</em> a web service (or main container) at runtime.</p>
<p>And after reading this you should be able to do something equivalent to this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  KeycloakSupportDecorator<span style="color:#f92672">(</span>LegacyJavaService<span style="color:#f92672">)</span>
</code></pre></div><p>Or</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  NotifyOnCrashDecorator<span style="color:#f92672">(</span>MigratedJ2EEService<span style="color:#f92672">)</span>
</code></pre></div><h1 id="writing-our-decorator-container">Writing Our Decorator Container</h1>
<p>To make this container we need to write a process capable of handling the protocol (HTTP 1.x messages) of our target container. To make things easier (<em>at least for me</em>) we are going to write this in Node.JS.</p>
<p>I wrote some boiler in the form of API called <a href="https://www.npmjs.com/package/node-ambassador">node-ambassador</a>, which takes care of the laborious details behind interprocess communication.</p>
<p>We can start by creating a Node.JS project and install the <a href="https://www.npmjs.com/package/node-ambassador">node-ambassador</a> library using <a href="https://www.npmjs.com">NPM</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  mkdir /&lt;project-folder&gt;
  cd /&lt;folder-project&gt;

  npm init <span style="color:#75715e"># creates the package.json</span>
  npm install node-ambassador --save <span style="color:#75715e">#install library</span>
</code></pre></div><p>Here is the minimum to code to create our proxy like process:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">Ambassador</span> }  <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;../node-ambassador/&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TARGET</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>[<span style="color:#e6db74">&#39;target_port&#39;</span>] <span style="color:#f92672">||</span> <span style="color:#ae81ff">8087</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PORT</span>   <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>[<span style="color:#e6db74">&#39;port&#39;</span>] <span style="color:#f92672">||</span> <span style="color:#ae81ff">8080</span>

<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Ambassador</span>({<span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">PORT</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">TARGET</span>})
      .<span style="color:#a6e22e">tunnel</span>({})

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">listening for request in </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PORT</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> and targeting </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">TARGET</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)
</code></pre></div><p>We read the TCP port information from <code>PORT</code> and <code>TARGET_PORT</code> from the environment variables, then we make a new <em>Ambassador</em> object and call the <code>tunnel</code> method which creates a tunnel between this two point.</p>
<h3 id="testing">Testing</h3>
<p>To test our <em>decorator</em> process we should execute a process in the same IP address capable of understanding HTTP (version 1.+). We are going to choose Python <a href="https://docs.python.org/2/library/simplehttpserver.html">simple server module</a> to do this.</p>
<p>Assuming you have Python installed, you just execute this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  python -m SimpleHTTPServer <span style="color:#ae81ff">8087</span>
</code></pre></div><p>If you don't have Python, you can use <a href="https://dzone.com/articles/docker-for-beginners">Docker</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cd /&lt;folder-you-want-serve&gt;

<span style="color:#75715e">#copy &amp; paste this line</span>
sudo docker run -it -v <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>:/app:z -p 8087:8087 --name py-server python python -m http.server <span style="color:#ae81ff">8087</span> --directory /app/
</code></pre></div><p>That would create for you an container serving the folder you are in, once this container is created you can save yourself of writing that long command by doing:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#stop</span>
docker stop py-server

<span style="color:#75715e">#start</span>
docker start py-server
</code></pre></div><p>Live example:</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/istio-2/python-server.gif" alt=""></p>
<h4 id="testing-our-tunnel">Testing Our Tunnel</h4>
<p>To execute our script we can configure the environment variables, <code>TARGET_PORT</code> to target the Python server and <code>PORT</code> the TCP port we want to listen to.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">export PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>
export TARGET_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8087</span>

node app.js
</code></pre></div><p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/istio-2/proxy-v1.gif?raw=true" alt="proxy-v1"></p>
<blockquote>
<p>In this example I just pick another image folder.</p>
</blockquote>
<h2 id="decorating-responses">Decorating Responses</h2>
<p>That Python server represents the main container, our purpose now is to change its behaviour, what we are going to do is to change that boring 404 page with something more enterprise ready and also make this change reusable with other containers.</p>
<p>So go back to the code and let's define a 404 page using this <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">string template</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">HTTP404</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">
</span><span style="color:#e6db74">HTTP/1.0 404 File not found
</span><span style="color:#e6db74">Server: Sitio ðŸ’¥
</span><span style="color:#e6db74">Date: </span><span style="color:#e6db74">${</span>Date()<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Content-Type: text/html
</span><span style="color:#e6db74">Connection: close
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">&lt;body&gt;
</span><span style="color:#e6db74">  &lt;H1&gt;Look Somewhere Else /  Not Found&lt;/H1&gt;
</span><span style="color:#e6db74">  &lt;img src=&#34;https://www.wykop.pl/cdn/c3201142/comment_E6icBQJrg2RCWMVsTm4mA3XdC9yQKIjM.gif&#34;&gt;
</span><span style="color:#e6db74">&lt;/body&gt;</span><span style="color:#e6db74">`</span>
</code></pre></div><p>All good, now the <code>node-ambassador</code> API provides a mechanism to detect when the target container sends an HTTP status code, this way we don't write to parse the HTTP response, so let's use it.</p>
<p>We need to make a function first and pass this function to the <code>tunnel</code> method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">override_404</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {}

<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Ambassador</span>({<span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">PORT</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">TARGET</span>})
      .<span style="color:#a6e22e">tunnel</span>({<span style="color:#a6e22e">override_404</span>})
</code></pre></div><p>Our <code>override_404</code> function will receive two object one handling the I/O of our target container called <code>service</code>, other handling the request initiator <code>server</code>, we can listen for events like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:${http_status}&#39;</span>, (<span style="color:#a6e22e">header</span>, <span style="color:#a6e22e">payload</span>) =&gt; {} )

 <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">examples</span>
 <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:500&#39;</span>, <span style="color:#a6e22e">header</span> =&gt; <span style="color:#a6e22e">send_mail</span>() )
 <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:500&#39;</span>, <span style="color:#a6e22e">header</span> =&gt; <span style="color:#a6e22e">log_cause</span>({<span style="color:#a6e22e">http_req</span>}) )
</code></pre></div><p>To detect a HTTP 404 we do this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">override_404</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
  <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:404&#39;</span>, () =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;404 Detected!&#39;</span>))
}
</code></pre></div><p>We respond with our replacement page:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">override_404</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
  <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:404&#39;</span>,  () =&gt; <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">respond</span>(<span style="color:#a6e22e">HTTP404</span>))
}
</code></pre></div><p>This method <code>respond</code> basically send the message and close the TCP Socket overriding any response. Here is the full script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">Ambassador</span> }  <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;../node-ambassador/&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TARGET</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>[<span style="color:#e6db74">&#39;target_port&#39;</span>] <span style="color:#f92672">||</span> <span style="color:#ae81ff">8087</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PORT</span>   <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>[<span style="color:#e6db74">&#39;port&#39;</span>] <span style="color:#f92672">||</span> <span style="color:#ae81ff">8080</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">override_404</span>({<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">server</span>}) {
  <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;http:404&#39;</span>, () =&gt; <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">respond</span>(<span style="color:#a6e22e">HTTP404</span>))
}

<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Ambassador</span>({<span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">PORT</span>, <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">TARGET</span>})
      .<span style="color:#a6e22e">tunnel</span>({<span style="color:#a6e22e">override_404</span>})

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">listening for request in </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PORT</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> and targeting </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">TARGET</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)
</code></pre></div><p><img src="https://github.com/cesarvr/hugo-blog/blob/master/static/istio-2/proxy-v2.gif?raw=true" alt="proxy-v2"></p>
<h2 id="creating-our-container">Creating Our Container</h2>
<p>We need to transform our script into a container image, OpenShift provides a mechanism called the <a href="https://cesarvr.io/post/buildconfig/">build configuration</a>, capable of doing this for us, but first we need to tune our project.</p>
<blockquote>
<p>If you get lost in some Kubernetes/OpenShift jargon you can refresh your knowledge with this <a href="https://github.com/cesarvr/Openshift">getting started guide</a>.</p>
</blockquote>
<!-- raw HTML omitted -->
<h4 id="project-configuration">Project Configuration</h4>
<p>Our project have to run using <a href="https://docs.npmjs.com/cli/start">npm start</a>, we can enable it by adding the proper configuration.</p>
<p>Add this line to the <code>package.json</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">  <span style="color:#e6db74">&#34;start&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;node app.js&#34;</span>      
</code></pre></div><p>Inside the <em>scripts</em> section:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;sitio&#34;</span>,
  <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;1.0.0&#34;</span>,
  <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
  <span style="color:#f92672">&#34;main&#34;</span>: <span style="color:#e6db74">&#34;app.js&#34;</span>,
  <span style="color:#f92672">&#34;scripts&#34;</span>: {
    <span style="color:#f92672">&#34;test&#34;</span>: <span style="color:#e6db74">&#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;</span>,
    <span style="color:#f92672">&#34;start&#34;</span> : <span style="color:#e6db74">&#34;node app.js&#34;</span>      
  },
  <span style="color:#f92672">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
  <span style="color:#f92672">&#34;license&#34;</span>: <span style="color:#e6db74">&#34;ISC&#34;</span>
}
</code></pre></div><p>This should work now:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">  <span style="color:#a6e22e">npm</span> <span style="color:#a6e22e">start</span>
</code></pre></div><h4 id="build-configuration">Build Configuration</h4>
<p>Next step is to create the <a href="https://cesarvr.io/post/buildconfig/">build configuration</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  oc new-build nodejs --binary<span style="color:#f92672">=</span>true --name<span style="color:#f92672">=</span>decorator
</code></pre></div><p>Now we need to run the build and lookup for the generated image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#cd /jump-to-your-script-folder</span>

oc start-build bc/decorator --from-dir<span style="color:#f92672">=</span>.

<span style="color:#75715e">#Uploading directory &#34;.&#34; as binary input for the build ...</span>
<span style="color:#75715e">#build &#34;decorator-1&#34; started</span>
<span style="color:#75715e">#....</span>
<span style="color:#75715e">#....</span>


oc get is
<span style="color:#75715e">#NAME        DOCKER REPO                       ...</span>
<span style="color:#75715e">#decorator   172.30.1.1:5000/hello/decorator   ...</span>
</code></pre></div><p>Our image is stored here: <code>172.30.1.1:5000/hello/decorator</code></p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/istio-2/start-build.gif" alt=""></p>
<h3 id="pod">Pod</h3>
<p>If you remember the <a href="https://cesarvr.io/post/istio/">first article</a> we build our <em>pod</em> using this template:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">apiversion: v1
kind: Pod
metadata:
  name: my-pod
  labels:
    app: my-pod
spec:
  containers:
  - name: web
    image: docker-registry.default.svc:5000/web-apps/web
    command: [&#39;sh&#39;, &#39;-c&#39;, &#39;cd static <span style="color:#960050;background-color:#1e0010">&amp;</span><span style="color:#960050;background-color:#1e0010">&amp;</span> python -m http.server 8087&#39;]
  - name: proxy
    image: busybox
    command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo Hello World 2 <span style="color:#960050;background-color:#1e0010">&amp;</span><span style="color:#960050;background-color:#1e0010">&amp;</span> sleep 3600&#39;]
</code></pre></div><p>This template deploys two containers:</p>
<ul>
<li><strong>web</strong> running a python web server</li>
<li><strong>proxy</strong> running a dummy sleep process.</li>
</ul>
<p>We need to replace the image for the <strong>proxy</strong> (<code>busybox</code>) with the one generated by our build:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">apiversion: v1
kind: Pod
metadata:
  name: my-pod
  labels:
    app: my-pod
spec:
 containers:
 - name: web
   image: docker-registry.default.svc:5000/web-apps/web
   command: [&#39;sh&#39;, &#39;-c&#39;, &#39;cd static <span style="color:#960050;background-color:#1e0010">&amp;</span><span style="color:#960050;background-color:#1e0010">&amp;</span> python -m http.server 8087&#39;]
 - name: proxy
   port: 8080
   image: 172.30.1.1:5000/hello/decorator
</code></pre></div><p>We removed the <code>command</code> section as its no longer necessary and added a TCP port 8080 to be expose.</p>
<h3 id="exposing-our-pod">Exposing Our Pod</h3>
<p>Let's send some traffic to our pod.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  oc create service loadbalancer my-pod --tcp<span style="color:#f92672">=</span>8080:8080
</code></pre></div><p>The <a href="https://github.com/cesarvr/Openshift#service">OpenShift Service</a> represents a load balancer that we can configure to send traffic to our application.</p>
<p>By choosing the same name <code>my-pod</code> it will automatically look for pods with that name and direct traffic to them using port 8080. Last step is to create a route for this Service.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  oc expose svc my-pod
</code></pre></div><!-- raw HTML omitted -->
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/istio-2/decorating%20a%20service.gif" alt=""></p>
<blockquote>
<p>Here we are running a Python service, enhanced with our container.</p>
</blockquote>
<h3 id="reusing-our-404-page-with-a-java-micro-services">Reusing our 404 Page with a Java Micro-services</h3>
<p>We are going to decorate a Java service, but there is a small problem, this service is not following the good practice of setting up the listening port using environment variables, but fortunately our container follow those rules.</p>
<p>So what I going to do is to install the container and then configure the environment variable to change the ports.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"> oc set env -c decorator dc/slow-j TARGET_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8087</span>
</code></pre></div><p>Then modify the OpenShift Service to target the right port.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">  oc create service loadbalancer java-service --tcp<span style="color:#f92672">=</span>8087:8087
</code></pre></div><p><img src="https://raw.githubusercontent.com/cesarvr/ambassador/master/assets/final.gif" alt=""></p>
<blockquote>
<p>Those logs you see in the right section of the image is a networking profiler that didn't make it here, because this post was getting to big, but I will include it in another post.</p>
</blockquote>
<p>This the equivalent of doing:</p>
<pre><code> DecoratorJS(JavaMicroService)
</code></pre><h4 id="wrapping-up">Wrapping Up</h4>
<p>I think for now we achieve our goal of making a minimal version of a decorator container, now we can enhance it and build more sophisticated features. Also I think this type of deployment make a good use case for A/B testing as a way to detect implementation failures and detect any performance problems in our container.</p>
<p>By know you should be able to experiment yourself using the API (our creating your own API) and coming up with new usages, if short of ideas, you can start with a simple robot that detect/report crashes in your services, if you want here is the <a href="https://github.com/cesarvr/ambassador">source code</a>, also feel free to contribute to the <a href="https://github.com/cesarvr/node-ambassador">node-ambassador</a> API in GitHub, with any missing features, improvement, etc.</p></div>
  <footer class="post-footer">
    
  </footer>
  
  
  
  
</article>
</main>
<footer class="footer">
  <span>&copy; 2020 Cesar</span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantclick/3.0.1/instantclick.min.js" integrity="sha256-SVgP0duWZXZFPVIX+woWPFhpnHcxG5IXS6zvZAVoa3Y=" crossorigin="anonymous"></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  addMenuListener();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    addMenuListener();
  });
  function addMenuListener() {
    var $toggle = document.querySelector('.menu-toggle');
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>

