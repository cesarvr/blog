<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Finding Performance Bottlenecks in JavaScript. - Terminal</title>
  


  <meta name="twitter:site" content="@cvaldezr">
  <meta name="twitter:creator" content="@cvaldezr">
  <meta name="twitter:description" content="How to use the Chrome performance monitor to optimise JavaScript performance." />
  <meta name="twitter:title" content="Finding Performance Bottlenecks in JavaScript." />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="" />

  <meta property="og:title" content="Finding Performance Bottlenecks in JavaScript." />
  <meta property="og:description" content="How to use the Chrome performance monitor to optimise JavaScript performance." />
  <meta property="og:image" content="" />

  <meta name="description" content="One of my hobbies is to write (and sometimes re-write) graphic libraries in various languages. I like to do this because, for one thing I like to see cool animation flying on the screen and nice side effect is that when your code is not performant the animation on the screen will let you know, as simple as that if you write good enough code you will receive a quick feedback.">
  <meta name="author" content="Cesar">
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/atom-one-dark.min.css" integrity="sha256-akwTLZec/XAFvgYgVH1T5/369lhA2Efr22xzCNl1nHs=" crossorigin="anonymous" />
  <link href="https://cesarvr.iocss/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

  
  <link rel="apple-touch-icon" href="https://cesarvr.ioimg/apple-touch-icon.png">
  <link rel="icon" href="https://cesarvr.ioimg/favicon.ico">
  
  <meta name="generator" content="Hugo 0.62.2" />
  
  <link rel="alternate" type="application/atom+xml" href="https://cesarvr.ioindex.xml" title="Terminal">
  
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="https://cesarvr.io">Terminal</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="/about">About</a>
        </li>
        
        <li class="">
          <a href="/showcase">Showcase</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

  <script
    			  src="https://code.jquery.com/jquery-3.3.1.min.js"
    			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    			  crossorigin="anonymous"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" async></script>
  <script src="https://cesarvr.iojs/db.js"></script>

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title">Finding Performance Bottlenecks in JavaScript.</h1>
    <p class="post-meta">Cesar · 2018.9.6</p>
  </header>
  <div class="post-content"><p>One of my hobbies is to write (and sometimes re-write) graphic libraries in various languages. I like to do this because, for one thing I like to see cool animation flying on the screen and nice side effect is that when your code is not performant the animation on the screen will let you know, as simple as that if you write good enough code you will receive a quick feedback.</p>
<p>To test my library I wrote a small animation that draw 1600+ particles and in each frame I update speed and angle to get a vortex like effect, then I repeat this every 33 millisecond (ms) and if the code is good enough it will look like this:</p>
<p><a href="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/vortex-edge.gif">Edge</a></p>
<h1 id="chrome"><strong>Chrome</strong></h1>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/vortex-chrome.gif" alt="Chrome"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#a6e22e">particles</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">particle</span> =&gt; {
      <span style="color:#75715e">//update particles
</span><span style="color:#75715e"></span>
    })

    <span style="color:#a6e22e">particles</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">particle</span> =&gt; {
      <span style="color:#75715e">//render the particles
</span><span style="color:#75715e"></span>    })
</code></pre></div><p>I take a quick look at what at this loops and I got the impression that the problem has to do with the utilisation of <code>forEach</code> instead of using a classic for from C. This would sound silly but my rationale that for each iteration a memory scope was being created and that that was messing with the speed of my animation.</p>
<p>With that assumption I edited my code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">
  <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>let i<span style="color:#f92672">=</span>0; i&lt;particles.length; i++<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    let particle <span style="color:#f92672">=</span> particles<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>
    // update...
  <span style="color:#f92672">}</span>


  <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>let i<span style="color:#f92672">=</span>0; i&lt;particles.length; i++<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    let particle <span style="color:#f92672">=</span> particles<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>
    // render...
  <span style="color:#f92672">}</span>

  //....
</code></pre></div><p>Now there is more code and less syntactic sugar but it looked C like and was giving me the impression that maybe should be faster. But I run the code again and I got 10 FPS and I was like &ldquo;where are my other 50 frames?&quot;.</p>
<p>Now the code not only was slow but look uglier, this is what happen when you use the <a href="http://www.brendangregg.com/methodology.html">&ldquo;drunken man anti-method&rdquo;</a>.</p>
<h1 id="solving-the-mystery">Solving The Mystery</h1>
<p>Ironically Chrome has one of the best tools to instrument JavaScript applications and after this humbling experience, I decided that maybe I should give it a try, so I run the profiler and got this:</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/debugger-chrome.gif" alt="debugger-chrome"></p>
<p>My first surprise is to see how much the profiler has improved, I'm able to see the correlation between the frames, time and instructions executed. After watching that I discover how much I wasted my time.</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/profiling.PNG" alt="profiler"></p>
<p>To hunt the bottleneck I just need to look for functions that are beyond the <code>33ms</code> threshold, the profiler has facilitated this task by painting in yellow the spots that are lagging the most.</p>
<p>To look for a more detailed view I used the <em>Call Tree</em> section.</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/data!!.PNG" alt="data"></p>
<p>The performance problem was calling <em>gl.getError()</em> inside the <code>paint</code> function, in Chrome.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">paint</span>(<span style="color:#a6e22e">object</span>) {
  <span style="color:#75715e">/*
</span><span style="color:#75715e">     loading particles into WebGL 3.3ms
</span><span style="color:#75715e">  */</span>
  <span style="color:#a6e22e">gl</span>.<span style="color:#a6e22e">getError</span>() <span style="color:#75715e">// 119.8ms  
</span><span style="color:#75715e"></span>}

</code></pre></div><p>That method <code>gl.getError()</code> logs to the console any exception that happens on WebGL and for some reason calling this function is very slow (<strong>≈119ms</strong>) on Chrome, even when I run my demo with the inspector closed while other browsers like Edge seems to deactivate that logging mechanism.</p>
<p>I rolled back those ugly changes and run the code again, <a href="http://webgl-hello01.7e14.starter-us-west-2.openshiftapps.com/gl_point/">the demo now runs</a> at 60 FPS across all browsers (Android included).</p>
<h3 id="always-measure">Always measure</h3>
<p>The main problem was a mix of preconceived and laziness and as Michael Abrash put it his book the <a href="http://www.jagregory.com/abrash-black-book/#understanding-high-performance">Graphic Programming Black Book</a>.</p>
<blockquote>
<p>Assume nothing&hellip; If you don’t measure performance, you’re just guessing, and if you’re guessing, you’re not very likely to write top-notch code.</p>
</blockquote>
<p>If you want to take a look at the source code, the project is published in <a href="https://github.com/cesarvr/vortex/tree/gl_point">Github</a>.</p></div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="https://cesarvr.iotags/performance/">Performance</a></li>
      
    </ul>
    
  </footer>
  
  
  
  
</article>
</main>
<footer class="footer">
  <span>&copy; 2020 Cesar</span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantclick/3.0.1/instantclick.min.js" integrity="sha256-SVgP0duWZXZFPVIX+woWPFhpnHcxG5IXS6zvZAVoa3Y=" crossorigin="anonymous"></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  addMenuListener();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    addMenuListener();
  });
  function addMenuListener() {
    var $toggle = document.querySelector('.menu-toggle');
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>

