<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Finding Performance Bottlenecks in JavaScript. :: Cesar&#39;s Bitacora — A simple theme for Hugo</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="One of my hobbies is to write (and sometimes re-write) graphic libraries in various languages. I like to do this because, for one thing I like to see cool animation flying on the screen and nice side effect is that when your code is not performant the animation on the screen will let you know, as simple as that if you write good enough code you will receive a quick feedback.
"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://cesarvr.io/post/js-performance/" />





<link rel="stylesheet" href="https://cesarvr.io/assets/style.css">


<link rel="stylesheet" href="https://cesarvr.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://cesarvr.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://cesarvr.io/img/favicon.png">


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/static/logo/js.png"/>

<meta name="twitter:title" content="Finding Performance Bottlenecks in JavaScript."/>
<meta name="twitter:description" content="How to use the Chrome performance monitor to optimise JavaScript performance."/>



<meta property="og:title" content="Finding Performance Bottlenecks in JavaScript." />
<meta property="og:description" content="How to use the Chrome performance monitor to optimise JavaScript performance." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cesarvr.io/post/js-performance/" />
<meta property="og:image" content="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/static/logo/js.png" />
<meta property="article:published_time" content="2018-09-06T15:23:40+01:00" />
<meta property="article:modified_time" content="2020-01-14T16:40:16+00:00" /><meta property="og:site_name" content="Cesar&#39;s Bitacora" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/post">Showcase</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/post">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://cesarvr.io/post/js-performance/">Finding Performance Bottlenecks in JavaScript.</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2018-09-06
        </span>
      
      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://cesarvr.io/tags/performance/">Performance</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <p>One of my hobbies is to write (and sometimes re-write) graphic libraries in various languages. I like to do this because, for one thing I like to see cool animation flying on the screen and nice side effect is that when your code is not performant the animation on the screen will let you know, as simple as that if you write good enough code you will receive a quick feedback.</p>
<p>To test my library I wrote a small animation that draw 1600+ particles and in each frame I update speed and angle to get a vortex like effect, then I repeat this every 33 millisecond (ms) and if the code is good enough it will look like this:</p>
<p><a href="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/vortex-edge.gif">Edge</a></p>
<h1 id="chrome"><strong>Chrome</strong></h1>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/vortex-chrome.gif" alt="Chrome"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#a6e22e">particles</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">particle</span> =&gt; {
      <span style="color:#75715e">//update particles
</span><span style="color:#75715e"></span>
    })

    <span style="color:#a6e22e">particles</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">particle</span> =&gt; {
      <span style="color:#75715e">//render the particles
</span><span style="color:#75715e"></span>    })
</code></pre></div><p>I take a quick look at what at this loops and I got the impression that the problem has to do with the utilisation of <code>forEach</code> instead of using a classic for from C. This would sound silly but my rationale that for each iteration a memory scope was being created and that that was messing with the speed of my animation.</p>
<p>With that assumption I edited my code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">
  <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>let i<span style="color:#f92672">=</span>0; i&lt;particles.length; i++<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    let particle <span style="color:#f92672">=</span> particles<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>
    // update...
  <span style="color:#f92672">}</span>


  <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>let i<span style="color:#f92672">=</span>0; i&lt;particles.length; i++<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    let particle <span style="color:#f92672">=</span> particles<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>
    // render...
  <span style="color:#f92672">}</span>

  //....
</code></pre></div><p>Now there is more code and less syntactic sugar but it looked C like and was giving me the impression that maybe should be faster. But I run the code again and I got 10 FPS and I was like &ldquo;where are my other 50 frames?&quot;.</p>
<p>Now the code not only was slow but look uglier, this is what happen when you use the <a href="http://www.brendangregg.com/methodology.html">&ldquo;drunken man anti-method&rdquo;</a>.</p>
<h1 id="solving-the-mystery">Solving The Mystery</h1>
<p>Ironically Chrome has one of the best tools to instrument JavaScript applications and after this humbling experience, I decided that maybe I should give it a try, so I run the profiler and got this:</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/debugger-chrome.gif" alt="debugger-chrome"></p>
<p>My first surprise is to see how much the profiler has improved, I'm able to see the correlation between the frames, time and instructions executed. After watching that I discover how much I wasted my time.</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/profiling.PNG" alt="profiler"></p>
<p>To hunt the bottleneck I just need to look for functions that are beyond the <code>33ms</code> threshold, the profiler has facilitated this task by painting in yellow the spots that are lagging the most.</p>
<p>To look for a more detailed view I used the <em>Call Tree</em> section.</p>
<p><img src="https://raw.githubusercontent.com/cesarvr/hugo-blog/master/static/js-performance/data!!.PNG" alt="data"></p>
<p>The performance problem was calling <em>gl.getError()</em> inside the <code>paint</code> function, in Chrome.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">paint</span>(<span style="color:#a6e22e">object</span>) {
  <span style="color:#75715e">/*
</span><span style="color:#75715e">     loading particles into WebGL 3.3ms
</span><span style="color:#75715e">  */</span>
  <span style="color:#a6e22e">gl</span>.<span style="color:#a6e22e">getError</span>() <span style="color:#75715e">// 119.8ms  
</span><span style="color:#75715e"></span>}

</code></pre></div><p>That method <code>gl.getError()</code> logs to the console any exception that happens on WebGL and for some reason calling this function is very slow (<strong>≈119ms</strong>) on Chrome, even when I run my demo with the inspector closed while other browsers like Edge seems to deactivate that logging mechanism.</p>
<p>I rolled back those ugly changes and run the code again, <a href="http://webgl-hello01.7e14.starter-us-west-2.openshiftapps.com/gl_point/">the demo now runs</a> at 60 FPS across all browsers (Android included).</p>
<h3 id="always-measure">Always measure</h3>
<p>The main problem was a mix of preconceived and laziness and as Michael Abrash put it his book the <a href="http://www.jagregory.com/abrash-black-book/#understanding-high-performance">Graphic Programming Black Book</a>.</p>
<blockquote>
<p>Assume nothing&hellip; If you don’t measure performance, you’re just guessing, and if you’re guessing, you’re not very likely to write top-notch code.</p>
</blockquote>
<p>If you want to take a look at the source code, the project is published in <a href="https://github.com/cesarvr/vortex/tree/gl_point">Github</a>.</p>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://cesarvr.io/post/istio/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Creating Your Own Istio (Part 1)</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://cesarvr.io/post/buildconfig/">
                  <span class="button__text">4 Ways to Build Applications in OpenShift</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    
    

    
      
        

      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Cesar&#39;s Bitacora</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://cesarvr.io/assets/main.js"></script>
<script src="https://cesarvr.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
